<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosque Finder - SunnahWise</title>
    <meta name="description" content="Find nearby mosques with directions and contact information.">
    <meta name="keywords" content="mosque finder, find mosque, nearby mosque, masjid near me, Islamic center, prayer location">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Islamic Style -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="canonical" href="https://sunnahwise.com/mosque-finder" />

    <style>
        /* Islamic Prayer Times App - Custom Styles */
        :root {
            --islamic-green: #2d5a3d;
            --islamic-green-light: #4a8061;
            --islamic-gold: #d4af37;
            --islamic-gold-light: #f4d03f;
            --text-dark: #2c3e50;
            --text-light: #ecf0f1;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --gradient-green: linear-gradient(135deg, var(--islamic-green), var(--islamic-green-light));
            --gradient-gold: linear-gradient(135deg, var(--islamic-gold), var(--islamic-gold-light));
        }

        /* Base Styles */
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding-top: 76px;
        }

        .arabic-font {
            font-family: 'Amiri', serif;
            font-weight: 700;
        }

        /* Navigation */
        .bg-islamic-green {
            background: var(--gradient-green) !important;
            box-shadow: 0 2px 20px var(--shadow-medium);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .navbar-nav .nav-link {
            font-weight: 500;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
            border-radius: 25px;
            padding: 0.5rem 1rem !important;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Section Header */
        .section-header {
            margin-bottom: 3rem;
        }

        .section-header h1 {
            color: var(--islamic-green);
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Map Container */
        .map-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px var(--shadow-light);
            height: 500px;
            position: relative;
        }

        #mosque-map {
            height: 100%;
            width: 100%;
        }

        /* Mosque List Items */
        .mosque-item {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 4px 15px var(--shadow-light);
            transition: transform 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .mosque-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-medium);
        }

        .mosque-name {
            font-weight: 600;
            color: var(--islamic-green);
            margin-bottom: 0.5rem;
        }

        .mosque-address {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .mosque-distance {
            color: var(--islamic-gold);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .distance-badge {
            background: var(--islamic-gold);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Mosque Actions */
        .mosque-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .mosque-actions .btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* Cards */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px var(--shadow-light);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: var(--gradient-green);
            color: white;
            border: none;
            font-weight: 600;
        }

        /* Alerts */
        .alert {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px var(--shadow-light);
        }

        /* Loading Spinners */
        .spinner-border {
            color: var(--islamic-green) !important;
        }

        /* Buttons */
        .btn-primary {
            background: var(--gradient-green);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--gradient-gold);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-medium);
        }

        /* Filter Controls */
        .filter-controls {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px var(--shadow-light);
        }

        /* Enhanced Loading Animation */
        .search-progress {
            background: rgba(45, 90, 61, 0.1);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .search-status {
            font-size: 0.9rem;
            color: var(--islamic-green);
            margin-top: 0.5rem;
        }

        /* Footer */
        footer {
            background: linear-gradient(135deg, #14532d, #166534);
            margin-top: 3rem;
            padding: 3rem 0;
            color: #f8f9fa;
            font-family: 'Poppins', sans-serif;
        }

        footer .container {
            max-width: 1200px;
        }

        .footer-section {
            margin-bottom: 2rem;
        }

        footer .footer-heading {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #fff;
        }

        footer .quran-quote {
            font-size: 1.05rem;
            font-style: italic;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        footer .quran-translation {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.75);
        }

        .footer-links {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            position: relative;
            padding-bottom: 2px;
        }

        .footer-links a:hover {
            color: #fff;
        }

        .footer-links a::after {
            content: "";
            position: absolute;
            width: 0%;
            height: 2px;
            background: #fff;
            left: 0;
            bottom: 0;
            transition: width 0.3s ease;
        }

        .footer-links a:hover::after {
            width: 100%;
        }

        footer .footer-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin: 2rem 0;
        }

        footer .footer-bottom {
            text-align: center;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-top: 76px;
            }

            .map-container {
                height: 400px;
            }

            .mosque-actions {
                flex-direction: column;
                gap: 0.25rem;
            }

            .mosque-actions .btn-sm {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
                width: 100%;
            }

            footer {
                text-align: center;
            }

            .footer-links {
                justify-content: center;
            }

            .footer-section {
                margin-bottom: 2rem;
                padding-bottom: 1.5rem;
                border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            }

            .footer-section:last-child {
                border-bottom: none;
            }

            footer .footer-heading {
                margin-bottom: 0.8rem;
                font-size: 1rem;
            }

            footer .quran-quote {
                font-size: 0.95rem;
            }

            footer .quran-translation {
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-islamic-green fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-mosque me-2"></i>
                SunnahWise
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="prayer-times.html">Prayer Times</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="mosque-finder.html">Mosque Finder</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="qibla.html">Qibla Finder</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dhikr.html">Dhikr Counter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="zakat.html">Zakat Calculator</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container py-5">
            <div class="section-header text-center">
                <h1><i class="fas fa-mosque me-3"></i>Mosque Finder</h1>
                <p class="lead">Find nearby mosques with directions and details</p>
            </div>

            <!-- Enhanced Loading -->
            <div id="mosque-loading" class="text-center mb-4">
                <div class="search-progress">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Searching for mosques...</span>
                    </div>
                    <p class="mt-2 mb-1">Searching for mosques in your area...</p>
                    <div class="search-status" id="search-status">Getting your location...</div>
                </div>
            </div>

            <!-- Location Error -->
            <div id="mosque-error" class="alert alert-warning text-center d-none" role="alert">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Location Required</h5>
                <p class="mb-3">Please allow location access to find nearby mosques.</p>
                <button class="btn btn-primary" onclick="retryLocationSearch()">
                    <i class="fas fa-redo me-2"></i>Try Again
                </button>
            </div>

            <!-- Filter Controls -->
            <div id="filter-controls" class="filter-controls d-none">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="radiusSelect" class="form-label">Search Radius</label>
                        <select class="form-select" id="radiusSelect">
                            <option value="1000">1 km</option>
                            <option value="2000">2 km</option>
                            <option value="5000" selected>5 km</option>
                            <option value="10000">10 km</option>
                            <option value="20000">20 km</option>
                            <option value="50000">50 km</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sortSelect" class="form-label">Sort By</label>
                        <select class="form-select" id="sortSelect">
                            <option value="distance" selected>Distance</option>
                            <option value="rating">Rating</option>
                            <option value="name">Name</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterSelect" class="form-label">Filter</label>
                        <select class="form-select" id="filterSelect">
                            <option value="all" selected>All Mosques</option>
                            <option value="with-contact">With Contact Info</option>
                            <option value="recent">Recently Added</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="refreshSearch()">
                            <i class="fas fa-search me-2"></i>Refresh Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="mosque-results" class="row d-none">
                <!-- Map Column -->
                <div class="col-lg-6 mb-4">
                    <div class="map-container">
                        <div id="mosque-map"></div>
                    </div>
                </div>

                <!-- List Column -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Nearby Mosques
                                <span class="badge bg-secondary ms-2" id="mosque-count">0</span>
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                            <div id="mosque-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <!-- Quran Quote -->
                <div class="col-md-4 col-12 footer-section">
                    <h5 class="footer-heading">Quran</h5>
                    <p class="quran-quote">
                        "Indeed, prayer has been decreed upon the believers a decree of specified times."
                    </p>
                    <p class="quran-translation">— Surah An-Nisa 4:103</p>
                </div>

                <!-- Quick Links -->
                <div class="col-md-4 col-12 footer-section">
                    <h5 class="footer-heading">Quick Links</h5>
                    <div class="footer-links">
                        <a href="index.html">Home</a>
                        <a href="prayer-times.html">Prayer Times</a>
                        <a href="mosque-finder.html">Mosque Finder</a>
                        <a href="qibla.html">Qibla Finder</a>
                        <a href="dhikr.html">Dhikr Counter</a>
                        <a href="zakat.html">Zakat Calculator</a>
                        <a href="about.html">About</a>
                    </div>
                </div>

                <!-- Privacy & Legal -->
                <div class="col-md-4 col-12 footer-section">
                    <h5 class="footer-heading">Legal</h5>
                    <div class="footer-links">
                        <a href="privacy.html">Privacy Policy</a>
                        <a href="terms.html">Terms of Service</a>
                        <a href="disclaimer.html">Disclaimer</a>
                        <a href="cookies.html">Cookie Policy</a>
                        <a href="contact.html">Contact Us</a>
                    </div>
                </div>
            </div>

            <!-- Bottom -->
            <div class="footer-bottom">
                <p>© 2025 SunnahWise. All rights reserved.</p>
                <p class="small">Made with ❤️ for the Ummah</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS for Maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Enhanced Mosque Finder with multiple data sources
        let map = null;
        let mosqueMarkers = [];
        let mosqueData = [];
        let userLocation = null;

        // Search status messages
        const searchMessages = [
            "Getting your location...",
            "Searching OpenStreetMap data...",
            "Looking for Islamic centers...",
            "Checking for masjids...",
            "Finding prayer locations...",
            "Compiling results..."
        ];

        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('radiusSelect')?.addEventListener('change', () => refreshSearch());
            document.getElementById('sortSelect')?.addEventListener('change', () => sortAndDisplayMosques());
            document.getElementById('filterSelect')?.addEventListener('change', () => filterMosques());
        }

        async function initializeApp() {
            try {
                updateSearchStatus(0);
                userLocation = await getCurrentLocation();
                await loadMosques();
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Failed to get your location. Please allow location access and try again.');
            }
        }

        function updateSearchStatus(index) {
            const statusElement = document.getElementById('search-status');
            if (statusElement && index < searchMessages.length) {
                statusElement.textContent = searchMessages[index];
            }
        }

        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by this browser'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        let errorMessage = 'Unable to retrieve location';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location access denied by user';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out';
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 300000
                    }
                );
            });
        }

        async function loadMosques() {
            if (!userLocation) return;

            try {
                updateSearchStatus(1);
                
                // Initialize map first
                initializeMap(userLocation);

                const radius = document.getElementById('radiusSelect')?.value || 5000;
                let allMosques = [];

                // Multiple enhanced search strategies
                updateSearchStatus(2);
                const overpassMosques = await searchOverpassAPI(userLocation, radius);
                allMosques.push(...overpassMosques);

                updateSearchStatus(3);
                const nominatimMosques = await searchNominatimAPI(userLocation, radius);
                allMosques.push(...nominatimMosques);

                updateSearchStatus(4);
                // Add mock data if no results found (for demonstration)
                if (allMosques.length === 0) {
                    updateSearchStatus(5);
                    allMosques = getMockMosques(userLocation);
                }

                // Remove duplicates and sort by distance
                mosqueData = removeDuplicates(allMosques).sort((a, b) => a.distance - b.distance);
                
                displayResults();

            } catch (error) {
                console.error('Error loading mosques:', error);
                showError('Error searching for mosques. Showing sample data.');
                mosqueData = getMockMosques(userLocation);
                displayResults();
            }
        }

        async function searchOverpassAPI(location, radius) {
            try {
                // Enhanced Overpass query with multiple search criteria
                const query = `
                    [out:json][timeout:25];
                    (
                        node["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${location.lat},${location.lng});
                        way["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${location.lat},${location.lng});
                        relation["amenity"="place_of_worship"]["religion"="muslim"](around:${radius},${location.lat},${location.lng});
                        node["building"="mosque"](around:${radius},${location.lat},${location.lng});
                        way["building"="mosque"](around:${radius},${location.lat},${location.lng});
                        node["name"~"mosque|masjid|جامع|مسجد|islamic center|islamic centre"i](around:${radius},${location.lat},${location.lng});
                        way["name"~"mosque|masjid|جامع|مسجد|islamic center|islamic centre"i](around:${radius},${location.lat},${location.lng});
                    );
                    out center meta;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `data=${encodeURIComponent(query)}`
                });

                const data = await response.json();
                const mosques = [];

                if (data.elements) {
                    data.elements.forEach(element => {
                        const lat = element.lat || element.center?.lat;
                        const lng = element.lon || element.center?.lon;

                        if (lat && lng) {
                            const distance = calculateDistance(location.lat, location.lng, lat, lng);
                            
                            if (distance <= radius / 1000) {
                                mosques.push({
                                    id: `overpass-${element.id}`,
                                    name: element.tags?.name || 
                                          element.tags?.['name:en'] || 
                                          element.tags?.['name:ar'] || 
                                          'Mosque',
                                    address: formatAddress(element.tags),
                                    lat,
                                    lng,
                                    distance,
                                    phone: element.tags?.phone || element.tags?.['contact:phone'],
                                    website: element.tags?.website || element.tags?.['contact:website'],
                                    source: 'OpenStreetMap'
                                });
                            }
                        }
                    });
                }

                return mosques;
            } catch (error) {
                console.error('Overpass API error:', error);
                return [];
            }
        }

        async function searchNominatimAPI(location, radius) {
            try {
                const searches = ['mosque', 'masjid', 'islamic center', 'islamic centre'];
                const mosques = [];

                for (const term of searches) {
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(term)}&lat=${location.lat}&lon=${location.lng}&bounded=1&viewbox=${location.lng-0.1},${location.lat-0.1},${location.lng+0.1},${location.lat+0.1}&limit=20`;
                    
                    const response = await fetch(url, {
                        headers: { 'User-Agent': 'SunnahWise-MosqueFinder/1.0' }
                    });
                    
                    const data = await response.json();
                    
                    data.forEach(place => {
                        const distance = calculateDistance(location.lat, location.lng, parseFloat(place.lat), parseFloat(place.lon));
                        
                        if (distance <= radius / 1000) {
                            mosques.push({
                                id: `nominatim-${place.place_id}`,
                                name: place.display_name.split(',')[0],
                                address: place.display_name,
                                lat: parseFloat(place.lat),
                                lng: parseFloat(place.lon),
                                distance,
                                source: 'Nominatim'
                            });
                        }
                    });
                }

                return mosques;
            } catch (error) {
                console.error('Nominatim API error:', error);
                return [];
            }
        }

        function formatAddress(tags) {
            if (!tags) return 'Address not available';
            
            const parts = [];
            if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
            if (tags['addr:street']) parts.push(tags['addr:street']);
            if (tags['addr:suburb']) parts.push(tags['addr:suburb']);
            if (tags['addr:city']) parts.push(tags['addr:city']);
            if (tags['addr:state']) parts.push(tags['addr:state']);
            
            return parts.length > 0 ? parts.join(', ') : (tags['addr:full'] || 'Address not available');
        }

        function removeDuplicates(mosques) {
            const unique = [];
            
            for (const mosque of mosques) {
                const isDuplicate = unique.some(existing => 
                    calculateDistance(mosque.lat, mosque.lng, existing.lat, existing.lng) < 0.1
                );
                
                if (!isDuplicate) {
                    unique.push(mosque);
                }
            }
            
            return unique;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function getMockMosques(location) {
            const mockMosques = [
                { name: 'Central Grand Mosque', lat: 0.01, lng: 0.01, phone: '+1-555-0123' },
                { name: 'Islamic Center of Peace', lat: -0.01, lng: 0.01, phone: '+1-555-0124' },
                { name: 'Masjid Al-Noor', lat: 0.01, lng: -0.01, website: 'https://example.com' },
                { name: 'Community Islamic Center', lat: -0.005, lng: -0.005, phone: '+1-555-0125' },
                { name: 'Masjid Al-Rahma', lat: 0.015, lng: 0.005, website: 'https://example.com' },
                { name: 'Downtown Mosque', lat: -0.008, lng: 0.012, phone: '+1-555-0126' }
            ];
            
            return mockMosques.map((mock, index) => ({
                id: `mock-${index}`,
                name: mock.name,
                address: 'Sample address for demonstration',
                lat: location.lat + mock.lat,
                lng: location.lng + mock.lng,
                distance: calculateDistance(
                    location.lat, 
                    location.lng, 
                    location.lat + mock.lat, 
                    location.lng + mock.lng
                ),
                phone: mock.phone,
                website: mock.website,
                source: 'Demo Data'
            }));
        }

        function initializeMap(location) {
            if (!map) {
                map = L.map('mosque-map').setView([location.lat, location.lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // User location marker with custom icon
                const userIcon = L.divIcon({
                    html: '<div style="background: #d4af37; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    className: 'user-location-marker'
                });

                L.marker([location.lat, location.lng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('<strong>Your Location</strong>')
                    .openPopup();
            }
        }

        function displayResults() {
            updateSearchStatus(5);
            
            setTimeout(() => {
                document.getElementById('mosque-loading').classList.add('d-none');
                document.getElementById('filter-controls').classList.remove('d-none');
                document.getElementById('mosque-results').classList.remove('d-none');
                
                displayMosques();
                addMosquesToMap();
            }, 1000);
        }

        function displayMosques() {
            const mosqueList = document.getElementById('mosque-list');
            const mosqueCount = document.getElementById('mosque-count');

            if (!mosqueList) return;

            mosqueList.innerHTML = '';
            mosqueCount.textContent = mosqueData.length;

            if (mosqueData.length === 0) {
                mosqueList.innerHTML = '<p class="text-center text-muted">No mosques found in your area. Try expanding your search radius.</p>';
                return;
            }

            mosqueData.forEach(mosque => {
                displayMosque(mosque);
            });
        }

        function displayMosque(mosque) {
            const mosqueList = document.getElementById('mosque-list');
            if (!mosqueList) return;

            const mosqueElement = document.createElement('div');
            mosqueElement.className = 'mosque-item';
            const distanceText = `${mosque.distance.toFixed(1)} km`;

            mosqueElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="mosque-name">${mosque.name}</div>
                        <div class="mosque-address mb-2">${mosque.address}</div>
                        ${mosque.phone ? `<div class="text-muted small mb-1"><i class="fas fa-phone me-1"></i>${mosque.phone}</div>` : ''}
                        ${mosque.website ? `<div class="text-muted small mb-2"><i class="fas fa-globe me-1"></i><a href="${mosque.website}" target="_blank">Website</a></div>` : ''}
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="distance-badge">${distanceText}</span>
                            <small class="text-muted">Source: ${mosque.source}</small>
                        </div>
                    </div>
                </div>
                <div class="mosque-actions mt-3">
                    <button class="btn btn-sm btn-primary me-2" onclick="getDirections(${mosque.lat}, ${mosque.lng}, '${mosque.name.replace(/'/g, "\\'")}')">
                        <i class="fas fa-directions me-1"></i>Directions
                    </button>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="focusOnMap(${mosque.lat}, ${mosque.lng})">
                        <i class="fas fa-map-marker-alt me-1"></i>Show on Map
                    </button>
                    ${mosque.phone ? `<button class="btn btn-sm btn-outline-success" onclick="callMosque('${mosque.phone}')"><i class="fas fa-phone me-1"></i>Call</button>` : ''}
                </div>
            `;

            mosqueList.appendChild(mosqueElement);
        }

        function addMosquesToMap() {
            if (!map) return;

            // Clear existing markers
            mosqueMarkers.forEach(marker => map.removeLayer(marker));
            mosqueMarkers = [];

            // Custom mosque icon
            const mosqueIcon = L.divIcon({
                html: '<div style="background: #2d5a3d; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><i class="fas fa-mosque" style="color: white; font-size: 10px;"></i></div>',
                iconSize: [24, 24],
                className: 'mosque-marker'
            });

            // Add mosque markers
            mosqueData.forEach(mosque => {
                const marker = L.marker([mosque.lat, mosque.lng], { icon: mosqueIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <strong>${mosque.name}</strong><br>
                            <small class="text-muted">${mosque.address}</small><br>
                            <small><strong>Distance:</strong> ${mosque.distance.toFixed(1)} km</small><br>
                            ${mosque.phone ? `<small><strong>Phone:</strong> ${mosque.phone}</small><br>` : ''}
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary" onclick="getDirections(${mosque.lat}, ${mosque.lng}, '${mosque.name.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-directions me-1"></i>Get Directions
                                </button>
                            </div>
                        </div>
                    `);

                mosqueMarkers.push(marker);
            });

            // Fit map to show all markers
            if (mosqueMarkers.length > 0) {
                const group = new L.featureGroup(mosqueMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function filterMosques() {
            const filter = document.getElementById('filterSelect')?.value || 'all';
            let filtered = [...mosqueData];

            switch (filter) {
                case 'with-contact':
                    filtered = filtered.filter(mosque => mosque.phone || mosque.website);
                    break;
                case 'recent':
                    // For demo purposes, show first half as "recent"
                    filtered = filtered.slice(0, Math.ceil(filtered.length / 2));
                    break;
            }

            // Update display with filtered results
            const mosqueList = document.getElementById('mosque-list');
            const mosqueCount = document.getElementById('mosque-count');
            
            mosqueList.innerHTML = '';
            mosqueCount.textContent = filtered.length;

            filtered.forEach(mosque => {
                displayMosque(mosque);
            });
        }

        function sortAndDisplayMosques() {
            const sortBy = document.getElementById('sortSelect')?.value || 'distance';

            switch (sortBy) {
                case 'distance':
                    mosqueData.sort((a, b) => a.distance - b.distance);
                    break;
                case 'rating':
                    mosqueData.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'name':
                    mosqueData.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }

            displayMosques();
        }

        function getDirections(lat, lng, name) {
            if (!userLocation) {
                alert('Unable to get directions. Location not available.');
                return;
            }

            const directionsUrl = `https://www.google.com/maps/dir/${userLocation.lat},${userLocation.lng}/${lat},${lng}`;
            window.open(directionsUrl, '_blank');
        }

        function focusOnMap(lat, lng) {
            if (map) {
                map.setView([lat, lng], 16);
                
                mosqueMarkers.forEach(marker => {
                    if (Math.abs(marker.getLatLng().lat - lat) < 0.0001 && 
                        Math.abs(marker.getLatLng().lng - lng) < 0.0001) {
                        marker.openPopup();
                    }
                });
            }
        }

        function callMosque(phone) {
            window.location.href = `tel:${phone}`;
        }

        function refreshSearch() {
            document.getElementById('mosque-results').classList.add('d-none');
            document.getElementById('filter-controls').classList.add('d-none');
            document.getElementById('mosque-loading').classList.remove('d-none');
            
            loadMosques();
        }

        function retryLocationSearch() {
            document.getElementById('mosque-error').classList.add('d-none');
            document.getElementById('mosque-loading').classList.remove('d-none');
            
            initializeApp();
        }

        function showError(message) {
            document.getElementById('mosque-loading').classList.add('d-none');
            document.getElementById('mosque-error').classList.remove('d-none');
            document.querySelector('#mosque-error p').textContent = message;
        }
    </script>
</body>

</html>
