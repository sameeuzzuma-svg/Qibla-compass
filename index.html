<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Qibla Compass</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            color: #333;
        }

        .container {
            text-align: center;
            max-width: 350px;
            width: 100%;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        /* The Main Compass Container - acts as a frame */
        .compass {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 20px auto;
        }

        /* The Compass Rose - This is what rotates! */
        .compass-rose {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #fff;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            /* Create the degree marks */
            background-image: 
                radial-gradient(circle, #fff 60%, transparent 60%),
                conic-gradient(
                    from 0deg,
                    transparent 0deg 1.5deg, #ff9990 1.5deg 3deg,
                    transparent 3deg 87deg, 
                    #ff9990 87deg 88.5deg,
                    transparent 88.5deg 88.8deg, #ff9990 88.8deg 90deg,
                    transparent 90deg 177deg, 
                    #ff9990 177deg 178.5deg,
                    transparent 178.5deg 178.8deg, #ff9990 178.8deg 180deg,
                    transparent 180deg 267deg, 
                    #ff9990 267deg 268.5deg,
                    transparent 268.5deg 268.8deg, #ff9990 268.8deg 270deg,
                    transparent 270deg 357deg, 
                    #ff9990 357deg 358.5deg,
                    transparent 358.5deg 358.8deg, #ff9990 358.8deg 360deg
                );
            /* This element will be rotated by JavaScript */
            transition: transform 0.1s ease; /* Smooth rotation */
        }

        .direction {
            position: absolute;
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.5em;
        }
        .direction:nth-child(1) { top: 15px; left: 50%; transform: translateX(-50%); } /* N */
        .direction:nth-child(2) { right: 15px; top: 50%; transform: translateY(-50%); } /* E */
        .direction:nth-child(3) { bottom: 15px; left: 50%; transform: translateX(-50%); } /* S */
        .direction:nth-child(4) { left: 15px; top: 50%; transform: translateY(-50%); } /* W */

        /* The Needle - This is FIXED and does not rotate with the rose! */
        .needle {
            position: absolute;
            width: 8px;
            height: 120px;
            background: linear-gradient(to top, #e74c3c 50%, #2c3e50 50%);
            border-radius: 4px;
            /* Center the needle in the .compass container */
            left: 50%;
            top: 50%;
            transform: translate(-50%, -100%);
            z-index: 10; /* Make sure it's on top of the rose */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            /* The needle itself will NOT be rotated. It points straight up to the Qibla on the rose. */
        }

        .info-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        #status {
            font-weight: bold;
            margin-bottom: 10px;
            color: #7f8c8d;
        }

        #angle {
            color: #27ae60;
            font-weight: bold;
        }

        #heading {
            color: #e74c3c;
            font-weight: bold;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Qibla Compass</h1>
        
        <!-- The entire compass container which will rotate -->
        <div class="compass">
            <div class="compass-rose" id="compassRose">
                <div class="direction">N</div>
                <div class="direction">E</div>
                <div class="direction">S</div>
                <div class="direction">W</div>
            </div>
            <!-- The needle is fixed and does NOT rotate with the rose -->
            <div class="needle" id="needle"></div>
        </div>

        <div class="info-panel">
            <p id="status">Click "Start Compass" to begin.</p>
            <!-- Add a button to initiate the compass -->
            <button id="permissionButton">Start Compass</button>
            <p>Qibla Direction: <span id="angle">0°</span></p>
            <p>Your Heading: <span id="heading">0°</span></p>
        </div>
    </div>

    <script>
        // Coordinates of the Kaaba, Mecca
        const QIBLA_LAT = 21.4225;
        const QIBLA_LONG = 39.8262;

        let userLatitude = null;
        let userLongitude = null;
        let qiblaAngle = null;

        // Get DOM elements
        const compassRose = document.getElementById('compassRose');
        const statusText = document.getElementById('status');
        const angleDisplay = document.getElementById('angle');
        const headingDisplay = document.getElementById('heading');
        const permissionButton = document.getElementById('permissionButton');

        // Function to calculate the Qibla bearing
        function calculateQiblaAngle(lat, long) {
            const phiK = QIBLA_LAT * Math.PI / 180.0;
            const lambdaK = QIBLA_LONG * Math.PI / 180.0;
            const phi = lat * Math.PI / 180.0;
            const lambda = long * Math.PI / 180.0;

            const psi = 180.0 / Math.PI * Math.atan2(
                Math.sin(lambdaK - lambda),
                (Math.cos(phi) * Math.tan(phiK) - Math.sin(phi) * Math.cos(lambdaK - lambda))
            );
            return (psi + 360) % 360;
        }

        function geoSuccess(position) {
            userLatitude = position.coords.latitude;
            userLongitude = position.coords.longitude;
            statusText.textContent = "Location found! Calculating Qibla...";

            qiblaAngle = calculateQiblaAngle(userLatitude, userLongitude);
            angleDisplay.textContent = qiblaAngle.toFixed(1) + '°';
            statusText.textContent = "Point your device towards the Qibla!";
            
            // Now that we have location, request device orientation
            requestDeviceOrientation();
        }

        function geoError(error) {
            console.error('Error getting location', error);
            statusText.textContent = "Error: " + error.message + ". Please enable GPS.";
        }

        function requestDeviceOrientation() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', deviceOrientationHandler);
                        } else {
                            statusText.textContent = "Permission not granted.";
                        }
                    })
                    .catch(console.error);
            } else if (window.DeviceOrientationEvent) {
                // For non-iOS browsers (Android/Chrome)
                window.addEventListener('deviceorientation', deviceOrientationHandler);
            } else {
                statusText.textContent = "Device Orientation not supported.";
            }
        }

        function deviceOrientationHandler(event) {
            let compassHeading = null;

            // Check if the event provides absolute orientation data (this is key!)
            if (event.absolute || typeof event.webkitCompassHeading !== 'undefined') {

                // 1. PRIORITY: Use iOS's built-in compass heading if available (most reliable for iOS)
                if (event.webkitCompassHeading) {
                    compassHeading = event.webkitCompassHeading;
                } 
                // 2. STANDARD: Calculate heading from alpha, beta, gamma for Android/others
                else if (event.alpha !== null) {
                    // Convert degrees to radians
                    const alpha = event.alpha * Math.PI / 180;
                    const beta = event.beta * Math.PI / 180;
                    const gamma = event.gamma * Math.PI / 180;

                    // Calculate Euler Angles to get a accurate compass heading
                    // This formula is a standard way to calculate the heading
                    const cosBeta = Math.cos(beta);
                    const sinBeta = Math.sin(beta);
                    const cosGamma = Math.cos(gamma);
                    const sinGamma = Math.sin(gamma);
                    
                    // Calculate the heading (azimuth)
                    const heading = Math.atan2(
                        sinGamma * cosBeta, 
                        sinBeta
                    );
                    
                    // Convert radians back to degrees and normalize (0-360)
                    compassHeading = heading * 180 / Math.PI;
                    compassHeading = (compassHeading + 360) % 360;
                }
            }

            // If we still don't have a valid heading, guide the user
            if (compassHeading === null) {
                statusText.textContent = "Move your phone in a figure-8 pattern to calibrate...";
                return;
            }

            // Update the UI with the calculated heading
            headingDisplay.textContent = compassHeading.toFixed(1) + '°';

            // THE CORE LOGIC: Rotate the compass rose to counter the phone's rotation.
            // This keeps the rose aligned with the real world (North is always North).
            compassRose.style.transform = `rotate(${-compassHeading}deg)`;
        }

        // Start the process on button click
        permissionButton.addEventListener('click', function() {
            statusText.textContent = "Requesting location...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(geoSuccess, geoError, { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 0 
                });
            } else {
                statusText.textContent = "Geolocation not supported.";
            }
            // Hide the button after clicking
            this.style.display = 'none';
        });
    </script>
</body>
</html>
