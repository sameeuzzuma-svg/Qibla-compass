<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qibla Finder - Islamic Prayer Times</title>
    <meta name="description" content="Find accurate direction to Mecca with compass.">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Islamic Style -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Islamic Prayer Times App - Custom Styles */
        :root {
            --islamic-green: #2d5a3d;
            --islamic-green-light: #4a8061;
            --islamic-gold: #d4af37;
            --islamic-gold-light: #f4d03f;
            --text-dark: #2c3e50;
            --text-light: #ecf0f1;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --gradient-green: linear-gradient(135deg, var(--islamic-green), var(--islamic-green-light));
            --gradient-gold: linear-gradient(135deg, var(--islamic-gold), var(--islamic-gold-light));
        }

        /* Base Styles */
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding-top: 76px;
        }

        .arabic-font {
            font-family: 'Amiri', serif;
            font-weight: 700;
        }

        /* Navigation */
        .bg-islamic-green {
            background: var(--gradient-green) !important;
            box-shadow: 0 2px 20px var(--shadow-medium);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .navbar-nav .nav-link {
            font-weight: 500;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
            border-radius: 25px;
            padding: 0.5rem 1rem !important;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Section Header */
        .section-header {
            margin-bottom: 3rem;
        }

        .section-header h1 {
            color: var(--islamic-green);
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Qibla Compass */
        .qibla-compass {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 30px var(--shadow-light);
            margin-bottom: 2rem;
        }

        /* Compass Styles from the provided code */
        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }

        .compass {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
        }

        .compass__rose {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .compass__rose__dial {
            height: 100%;
            width: 100%;
        }

        .compass__pointer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100%;
            width: 100%;
        }

        /* Status panel styling */
        .status-panel {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px var(--shadow-light);
            margin-bottom: 2rem;
        }

        .position-data {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 768px) {
            .position-data {
                grid-template-columns: 1fr;
            }
        }

        .data-item {
            margin-bottom: 10px;
        }

        .label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--islamic-green);
        }

        /* Buttons */
        .btn-primary {
            background: var(--gradient-green);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--gradient-gold);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-medium);
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-compass {
            background: var(--gradient-green);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-compass:hover {
            background: var(--gradient-gold);
            transform: translateY(-2px);
        }

        .btn-compass:active {
            transform: translateY(0);
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        /* Permission request */
        .permission-request {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px var(--shadow-light);
        }

        .accuracy-warning {
            text-align: center;
            color: #dc3545;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .qibla-direction {
            text-align: center;
            font-size: 1.5rem;
            margin: 20px 0;
            color: var(--islamic-gold);
            font-weight: bold;
        }

        /* Footer */
        footer {
            background: var(--gradient-green) !important;
            margin-top: 3rem;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.3s ease;
            margin: 0 10px;
            font-size: 0.9rem;
        }

        .footer-links a:hover {
            color: white;
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-top: 76px;
            }
            
            .compass-container {
                width: 250px;
                height: 250px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-compass {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="compass">
            <div id="rose" class="compass__rose">
                <svg class="compass__rose__dial" viewBox="0 0 130 130" version="1.1" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="65" cy="65" r="50" stroke="silver" stroke-width="5" fill="none" />
                    <polyline points="62,13  68,13  65,23" fill="silver"/>
                    <polyline points="117,63  117,67  110,65" fill="silver"/>
                    <polyline points="63,117  67,117  65,110" fill="silver"/>
                    <polyline points="13,63  13,67  20,65" fill="silver"/>
                    <text x="65" y="4.2" font-size="9" text-anchor="middle" fill="white">N</text>
                    <text x="127" y="67" font-size="9" text-anchor="middle" fill="white">E</text>
                    <text x="65" y="129" font-size="9" text-anchor="middle" fill="white">S</text>
                    <text x="2.8" y="67" font-size="9" text-anchor="middle" fill="white">W</text>
                    <image id="kabah" x="55" y="15" width="30" height="30" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDMwIDMwIj48cGF0aCBkPSJNMTUsMyBMMjcsMTUgTDE1LDI3IEwzLDE1IFoiIGZpbGw9IiNiNjAwMDAiLz48L3N2Zz4=" />
                </svg>
            </div>
            <svg class="compass__pointer" viewBox="0 0 130 130" version="1.1" xmlns="http://www.w3.org/2000/svg">
                <polyline points="56,65  74,65  65,19" fill="#b60000"/>
                <polyline points="56,65  74,65  65,111" fill="white"/>
                <circle cx="65" cy="65" r="5" stroke="#b60000" stroke-width="0" fill="black" />
            </svg>
        </div>
    </div>

    <div class='status'>
        <div id='debug-orientation-default'></div>
        <div id='debug-orientation'></div>

        <div class='position row'>
            <div id='position-lab'></div>
        </div>
        <div class='position row'>
            <div class='column-20'>
                <div class='label'>Compass Direction</div>
                <div id='position-hng'>n/a</div>
            </div>
            <div class='column-20'>
                <div class='label'>Qibla Direction</div>
                <div id='position-qib'>n/a</div>
            </div>
            <div class='column-25'>
                <div class='label'>Latitude</div>
                <div id='position-lat'>&#8943;</div>
            </div>
            <div class='column-33'>
                <div class='label'>Longitude</div>
                <div id='position-lng'>&#8943;</div>
            </div>
        </div>

        <div class="options row">
            <button id="btn-lock-orientation" class="btn btn--hide options__btn column-25" type="button">
                <svg alt="lock off" class="btn__icon btn__icon--inactive" version="1.1" xmlns="http://www.w3.org/2000/svg" width="512px" height="512px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
                    <path id="lock-15-icon" d="M256,90.001c91.74,0,166,74.243,166,166c0,91.74-74.243,165.998-166,165.998 c-91.741,0-166-74.241-166-165.998C90,164.259,164.243,90.001,256,90.001 M256,50.001c-113.771,0-206,92.229-206,206 s92.229,205.998,206,205.998c113.771,0,206-92.227,206-205.998S369.771,50.001,256,50.001L256,50.001z M358.999,242.667V347h-148 V242.667H358.999z M238.667,196.333v31.334h25v-31.334c0-30.511-24.822-55.333-55.334-55.333c-30.51,0-55.332,24.822-55.332,55.333 v31.334h25v-31.334c0-16.726,13.607-30.333,30.332-30.333C225.06,166,238.667,179.607,238.667,196.333z" fill="white" />
                </svg>
                <svg alt="lock on" class="btn__icon btn__icon--active" version="1.1" xmlns="http://www.w3.org/2000/svg" width="512px" height="512px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
                    <path id="lock-13-icon" d="M256,90.001c91.74,0,166,74.243,166,166c0,91.74-74.243,165.998-166,165.998 c-91.741,0-166-74.241-166-165.998C90,164.259,164.243,90.001,256,90.001 M256,50.001c-113.771,0-206,92.229-206,206 s92.229,205.998,206,205.998c113.771,0,206-92.227,206-205.998S369.771,50.001,256,50.001L256,50.001z M201.225,227.537v-31.585 c0-30.755,25.021-55.776,55.775-55.776s55.775,25.021,55.775,55.776v31.585h-25.2v-31.585c0-16.859-13.716-30.576-30.575-30.576 s-30.575,13.717-30.575,30.576v31.585H201.225z M182.409,242.656v105.169h149.182V242.656H182.409z" fill="white" />
                </svg>
            </button>
            <button id="btn-nightmode" class="btn options__btn column-33" type="button">
                <svg class="btn__icon btn__icon--inactive" version="1.1" xmlns="http://www.w3.org/2000/svg" width="512px" height="512px" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="butt" stroke-linejoin="round" enable-background="new 0 0 512 512" xml:space="preserve">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <svg class="btn__icon btn__icon--active" version="1.1" xmlns="http://www.w3.org/2000/svg" width="512px" height="512px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </button>
            <button id="btn-map" class="btn options__btn column-33" type="button">
                <svg alt="map" class="btn__icon btn__icon--inactive" version="1.1" xmlns="http://www.w3.org/2000/svg" width="512px" height="512px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
                    <path id="location-icon" d="M256,50c-72.072,0-130.5,58.427-130.5,130.5c0,72.073,57.114,155.833,130.5,281.5 c73.388-125.666,130.5-209.427,130.5-281.5C386.5,108.427,328.074,50,256,50z M256,224.133c-25.848,0-46.801-20.953-46.801-46.8 s20.953-46.8,46.801-46.8s46.801,20.953,46.801,46.8S281.848,224.133,256,224.133z" fill="white" />
                </svg>
            </button>
            <button id="btn-info" class="btn btn-popup options__btn column-33" type="button" data-name='info'>
                <svg alt="info" class="btn__icon btn__icon--inactive" version="1.1" xmlns="http://www.w3.org/2000/svg" width="512px" height="512px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
                    <path id="info-2-icon" d="M255.998,90.001c91.74,0,166.002,74.241,166.002,165.998c0,91.741-74.245,166-166.002,166 c-91.74,0-165.998-74.243-165.998-166C90,164.259,164.243,90.001,255.998,90.001 M255.998,50.001 C142.229,50.001,50,142.229,50,255.999c0,113.771,92.229,206,205.998,206c113.771,0,206.002-92.229,206.002-206 C462,142.229,369.77,50.001,255.998,50.001L255.998,50.001z M285.822,367.567h-57.646V230.6h57.646V367.567z M257,202.268 c-17.522,0-31.729-14.206-31.729-31.73c0-17.522,14.206-31.729,31.729-31.729c17.524,0,31.728,14.206,31.728,31.729 C288.728,188.062,274.524,202.268,257,202.268z" fill="white" />
                </svg>
            </button>
        </div>
    </div>

    <div id="popup" class="popup">
        <div id="popup-content" class="popup__content">
            <div id="popup-contents" class="popup__contents">
                <div id="popup-inner-info" class="popup__inner popup__inner--hide">
                    <p>
                        <b>Qibla Direction Compass</b> shows <em>current qibla directon using compass</em>. This qibla compass app utilizes your geographical location and other location services from your device to find qibla. Therefore, the qibla direction's accuracy shown depends on your device. Compass inside your smartphone can be affected by strong <b>magnetic fields</b> around it. For best results, stay away from magnets, metals, and other devices with magnetic fields. Calibrate your compass <em>by moving the device forming number 8 shape</em> vertically and horizontally a few times.
                    </p>
                    <p>
                        Find qibla direction for your location using <a href="https://www.al-habib.info/qibla-pointer/list-map-qibla-direction.htm" target="_blank">Qibla Direction Database</a> or use <a href="https://www.al-habib.info/qibla-pointer/interactive-qibla-pointer-map.htm" target="_blank">Interactive Qibla Pointer Map</a>.
                    </p>
                </div>
                <div id="popup-inner-noorientation" class="popup__inner popup__inner--hide">
                    <p>Unfortunately, your device or phone does not support location service or we cannot detect its compass.</p>
                    <p>Find your qibla direction using alternative method of using online map: <a href="https://www.al-habib.info/qibla-pointer/interactive-qibla-pointer-map.htm" target="_blank">Map-based Qibla Pointer</a> or <a href="https://www.al-habib.info/qibla-pointer/list-map-qibla-direction.htm" target="_blank">Database of Qibla Directions</a>.</p>
                </div>
            </div>
            <button id="popup-close" class="popup__close" href='#'>CLOSE</button>
        </div>
    </div>

    <script>
        (function () {
            "use strict";

            //set to true for debugging output
            var debug = false;

            // our current position
            var positionCurrent = {
                lat: null,
                lng: null,
                hng: null
            };
            
            var roundedCurlat, roundedCurlon;

            // intro text
            var intro = document.getElementById("intro");
            var introtext = intro.innerHTML;

            // qibla direction var
            let pointDegree;

            // location info
            var city, state, country;

            // the outer part of the compass that rotates
            var rose = document.getElementById("rose");

            // elements that ouput our position
            var positionLat = document.getElementById("position-lat");
            var positionLng = document.getElementById("position-lng");
            var positionHng = document.getElementById("position-hng");
            var positionQib = document.getElementById("position-qib");
            var positionLab = document.getElementById("position-lab");

            // debug outputs
            var debugOrientation = document.getElementById("debug-orientation");
            var debugOrientationDefault = document.getElementById("debug-orientation-default");

            // info popup elements, pus buttons that open popups
            var popup = document.getElementById("popup");
            var popupContents = document.getElementById("popup-contents");
            var popupInners = document.querySelectorAll(".popup__inner");
            var btnsPopup = document.querySelectorAll(".btn-popup");

            // buttons at the bottom of the screen
            var btnLockOrientation = document.getElementById("btn-lock-orientation");
            var btnNightmode = document.getElementById("btn-nightmode");
            var btnMap = document.getElementById("btn-map");
            var btnInfo = document.getElementById("btn-info");

            // if we have shown the heading unavailable warning yet
            var warningHeadingShown = false;

            // switches keeping track of our current app state
            var isOrientationLockable = false;
            var isOrientationLocked = false;
            var isNightMode = false;

            // the orientation of the device on app load
            var defaultOrientation;

            // browser agnostic orientation
            function getBrowserOrientation() {
                var orientation;
                if (screen.orientation && screen.orientation.type) {
                    orientation = screen.orientation.type;
                } else {
                    orientation = screen.orientation ||
                                screen.mozOrientation ||
                                screen.msOrientation;
                }
                return orientation;
            }

            // browser agnostic orientation unlock
            function browserUnlockOrientation() {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                } else if (screen.unlockOrientation) {
                    screen.unlockOrientation();
                } else if (screen.mozUnlockOrientation) {
                    screen.mozUnlockOrientation();
                } else if (screen.msUnlockOrientation) {
                    screen.msUnlockOrientation();
                }
            }

            // browser agnostic document.fullscreenElement
            function getBrowserFullscreenElement() {
                if (typeof document.fullscreenElement !== "undefined") {
                    return document.fullscreenElement;
                } else if (typeof document.webkitFullscreenElement !== "undefined") {
                    return document.webkitFullscreenElement;
                } else if (typeof document.mozFullScreenElement !== "undefined") {
                    return document.mozFullScreenElement;
                } else if (typeof document.msFullscreenElement !== "undefined") {
                    return document.msFullscreenElement;
                }
            }

            // browser agnostic document.documentElement.requestFullscreen
            function browserRequestFullscreen() {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
            }

            // browser agnostic document.documentElement.exitFullscreen
            function browserExitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }

            // called on device orientation change
            function onHeadingChange(event) {
                var heading = -1*event.webkitCompassHeading || event.alpha;
                var alpha;
                var orientation = getBrowserOrientation();

                if (typeof heading !== "undefined" && heading !== null) {
                    // we have a browser that reports device heading and orientation

                    if (debug) {
                        debugOrientation.textContent = orientation;
                    }

                    // what adjustment we have to add to rotation to allow for current device orientation
                    var adjustment = 0;
                    if (defaultOrientation === "landscape") {
                        adjustment -= 90;
                    }

                    if (typeof orientation !== "undefined") {
                        var currentOrientation = orientation.split("-");

                        if (defaultOrientation !== currentOrientation[0]) {
                            if (defaultOrientation === "landscape") {
                                adjustment -= 270;
                            } else {
                                adjustment -= 90;
                            }
                        }

                        if (currentOrientation[1] === "secondary") {
                            adjustment -= 180;
                        }
                    }

                    positionCurrent.hng = heading - window.orientation;// + adjustment;

                    var phase = positionCurrent.hng < 0 ? 360 + positionCurrent.hng : positionCurrent.hng;
                    positionHng.textContent = (360 - phase | 0) + "°";
                    //indicate heading near Qibla
                    var qiboffset = Math.abs((360 - phase) - pointDegree);
                    if(qiboffset < 15) {
                        alpha = (15 - qiboffset) / 15;
                        positionHng.style.background = "rgba(200,0,0,"+alpha+")";
                        kabah.style.background = "rgba(170,0,0,"+alpha+")";
                        intro.innerHTML = "&#128331; Qibla Direction Found &#128332;";
                        intro.style.color = "rgba(255,255,255,"+alpha+")";
                        intro.style.fontSize = "1.5em";
                        intro.style.textAlign = "center";
                    } else {
                        intro.style.color = "white";
                        intro.style.fontSize = "0.8em";
                        intro.style.textAlign = "left";
                        intro.innerHTML = introtext;
                        positionHng.style.background = "none";
                    }

                    // apply rotation to compass rose
                    if (typeof rose.style.transform !== "undefined") {
                        rose.style.transform = "rotateZ(" + positionCurrent.hng + "deg)";
                    } else if (typeof rose.style.webkitTransform !== "undefined") {
                        rose.style.webkitTransform = "rotateZ(" + positionCurrent.hng + "deg)";
                    }
                } else {
                    // device can't show heading
                    positionHng.textContent = "n/a";
                    showHeadingWarning();
                }
            }

            function showHeadingWarning() {
                if (!warningHeadingShown) {
                    popupOpen("noorientation");
                    warningHeadingShown = true;
                }
            }

            function onFullscreenChange() {
                if (isOrientationLockable && getBrowserFullscreenElement()) {
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock(getBrowserOrientation()).then(function () {
                        }).catch(function () {
                        });
                    }
                } else {
                    lockOrientationRequest(false);
                }
            }

            function toggleOrientationLockable(lockable) {
                isOrientationLockable = lockable;

                if (isOrientationLockable) {
                    btnLockOrientation.classList.remove("btn--hide");

                    btnNightmode.classList.add("column-25");
                    btnNightmode.classList.remove("column-33");
                    btnMap.setAttribute("title","Open map of qibla direction");
                    btnMap.classList.add("column-25");
                    btnMap.classList.remove("column-33");
                    btnInfo.classList.add("column-25");
                    btnInfo.classList.remove("column-33");
                } else {
                    btnLockOrientation.classList.add("btn--hide");

                    btnNightmode.classList.add("column-33");
                    btnNightmode.classList.remove("column-25");
                    btnMap.setAttribute("title","Open map of qibla direction");
                    btnMap.classList.add("column-33");
                    btnMap.classList.remove("column-25");
                    btnInfo.classList.add("column-33");
                    btnInfo.classList.remove("column-25");
                }
            }

            function checkLockable() {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock(getBrowserOrientation()).then(function () {
                        toggleOrientationLockable(true);
                        browserUnlockOrientation();
                    }).catch(function (event) {
                        if (event.code === 18) { // The page needs to be fullscreen in order to call lockOrientation(), but is lockable
                            toggleOrientationLockable(true);
                            browserUnlockOrientation(); //needed as chrome was locking orientation (even if not in fullscreen, bug??)
                        } else {  // lockOrientation() is not available on this device (or other error)
                            toggleOrientationLockable(false);
                        }
                    });
                } else {
                    toggleOrientationLockable(false);
                }
            }

            function lockOrientationRequest(doLock) {
                if (isOrientationLockable) {
                    if (doLock) {
                        browserRequestFullscreen();
                        lockOrientation(true);
                    } else {
                        browserUnlockOrientation();
                        browserExitFullscreen();
                        lockOrientation(false);
                    }
                }
            }

            function lockOrientation(locked) {
                if (locked) {
                    btnLockOrientation.classList.add("active");
                } else {
                    btnLockOrientation.classList.remove("active");
                }

                isOrientationLocked = locked;
            }

            function toggleOrientationLock() {
                if (isOrientationLockable) {
                    lockOrientationRequest(!isOrientationLocked);
                }
            }

            function locationNameUpdate(position) {
                roundedCurlat = Math.round(positionCurrent.lat * 1000) / 1000;
                roundedCurlon = Math.round(positionCurrent.lng * 1000) / 1000;

                var roundedLat = Math.round(position.coords.latitude * 1000) / 1000;
                var roundedLon = Math.round(position.coords.longitude * 1000) / 1000;
                if (roundedCurlat == roundedLat && roundedCurlon == roundedLon) {
                    //no change in position within about 0.1 km or 1/1000 of a degree
                } else {
                    // Replace these values with your actual latitude, longitude, and desired format
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    var format = "json";

                    var url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=${format}&zoom=15&layer=address&accept-language=id`;

                    // Create a new XMLHttpRequest object
                    var xhr = new XMLHttpRequest();

                    // Configure the request
                    xhr.open('GET', url, true);

                    // Set up a callback function to handle the response
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            // Parse the JSON response
                            var data = JSON.parse(xhr.responseText);

                            // Access the specific keys you need (city, state, and country)
                            city = data.name;
                            state = data.address.state;
                            country = data.address.country;

                            // Now, you can use these values as needed
                            positionLab.innerText = city + ", " + state;
                        }
                    };

                    // Send the request
                    xhr.send();
                }
            }

            function locationUpdate(position) {
                locationNameUpdate(position);
                locationHandler(position); //get qibla direction
                positionQib.textContent = pointDegree +"°";

                positionCurrent.lat = position.coords.latitude;
                positionCurrent.lng = position.coords.longitude;

                positionLat.textContent = decimalToSexagesimal(positionCurrent.lat, "lat");
                positionLng.textContent = decimalToSexagesimal(positionCurrent.lng, "lng");
            }

            function locationUpdateFail(error) {
                positionLat.textContent = "n/a";
                positionLng.textContent = "n/a";
                console.log("location fail: ", error);
            }

            function setNightmode(on) {
                if (on) {
                    btnNightmode.classList.add("active");
                } else {
                    btnNightmode.classList.remove("active");
                }

                window.setTimeout(function() {
                    if (on) {
                        document.documentElement.classList.add("nightmode");
                    } else {
                        document.documentElement.classList.remove("nightmode");
                    }
                }, 1);

                isNightMode = on;
            }

            function toggleNightmode() {
                setNightmode(!isNightMode);
            }

            function openMap() {
                var label = "Unknown location";
                if (city && state) {
                    label = city + ", " + state;
                }
                label = encodeURIComponent(label);
                window.location.assign("https://www.al-habib.info/qibla-pointer/interactive-qibla-pointer-map.htm?lat="+positionCurrent.lat+"&lon="+positionCurrent.lng+"&label="+label+"&ref=qibla+compass");
            }

            function openHome() {
                window.location.assign("https://www.al-habib.info/qibla-pointer/");
            }

            function popupOpenFromClick(event) {
                popupOpen(event.currentTarget.dataset.name);
            }

            function popupOpen(name) {
                var i;
                for (i=0; i<popupInners.length; i++) {
                    popupInners[i].classList.add("popup__inner--hide");
                }
                document.getElementById("popup-inner-" + name).classList.remove("popup__inner--hide");

                popup.classList.add("popup--show");
            }

            function popupClose() {
                popup.classList.remove("popup--show");
            }

            function popupContentsClick(event) {
                event.stopPropagation();
            }

            function decimalToSexagesimal(decimal, type) {
                var degrees = decimal | 0;
                var fraction = Math.abs(decimal - degrees);
                var minutes = (fraction * 60) | 0;
                var seconds = (fraction * 3600 - minutes * 60) | 0;

                var direction = "";
                var positive = degrees > 0;
                degrees = Math.abs(degrees);
                switch (type) {
                    case "lat":
                        direction = positive ? "N" : "S";
                        break;
                    case "lng":
                        direction = positive ? "E" : "W";
                        break;
                }

                return degrees + "°" + minutes + "'" + seconds + "\" " + direction;
            }

            function requestDeviceOrientation(callback) {
                if (window.DeviceOrientationEvent == null) {
                    callback(new Error("DeviceOrientation is not supported."));
                } else if (DeviceOrientationEvent.requestPermission) {
                    DeviceOrientationEvent.requestPermission().then(function(state) {
                        if (state == "granted") {
                            callback(null);
                        } else callback(new Error("Permission denied by user"));
                    }, function(err) {
                        callback(err);
                    });
                } else { // no need for permission
                    callback(null);
                }
            }

            function firstClick() {
                requestDeviceOrientation(function(err) {
                    if (err == null) {
                        window.removeEventListener("click", firstClick);
                        window.removeEventListener("touchend", firstClick);
                        window.addEventListener("devicemotion", function(e) {
                            // access e.acceleration, etc.
                        });
                    } else {
                        // failed; a JS error object is stored in `err`
                    }
                });
            }

            //Calculate qibla direction
            function locationHandler(position) {
                const { latitude, longitude } = position.coords;
                pointDegree = calcDegreeToPoint(latitude, longitude);
                if (pointDegree < 0) {
                    pointDegree = pointDegree + 360;
                }
                calcKabah(pointDegree);
            }

            function calcDegreeToPoint(latitude, longitude) {
                // Qibla geolocation
                const point = {
                    lat: 21.422487,
                    lng: 39.826206,
                };

                const phiK = (point.lat * Math.PI) / 180.0;
                const lambdaK = (point.lng * Math.PI) / 180.0;
                const phi = (latitude * Math.PI) / 180.0;
                const lambda = (longitude * Math.PI) / 180.0;
                const psi =
                    (180.0 / Math.PI) *
                    Math.atan2(
                        Math.sin(lambdaK - lambda),
                        Math.cos(phi) * Math.tan(phiK) -
                            Math.sin(phi) * Math.cos(lambdaK - lambda)
                    );
                return Math.round(psi);
            }

            //calculate Kabah icon position in the rose compass
            function calcKabah(pointDegree) {
                let kabah = document.getElementById("kabah");
                let circle = document.getElementsByTagName("circle")[0];
                let svgr = parseInt(circle.getAttribute("r"));
                let cx = parseInt(circle.getAttribute("cx"));
                let cy = parseInt(circle.getAttribute("cy"));
                let kw = parseInt(kabah.getAttribute("width"));
                let kh = parseInt(kabah.getAttribute("height"));
                let kx = Math.sin(pointDegree * Math.PI / 180) * svgr + cx - (kw / 2);
                let ky = - Math.cos(pointDegree * Math.PI / 180) * svgr + cy - (kh / 2);
                kabah.setAttribute("x", kx);
                kabah.setAttribute("y", ky);
                kabah.setAttribute("transform", "rotate(" + pointDegree +", "+ (kx + (kw/2)) +", " + (ky + (kh/2)) +")");
            }

            function D2R(degrees) {
                var pi = Math.PI;
                return degrees * (pi/180);
            }

            window.addEventListener("click", firstClick);
            window.addEventListener("touchend", firstClick);

            if (screen.width > screen.height) {
                defaultOrientation = "landscape";
            } else {
                defaultOrientation = "portrait";
            }
            if (debug) {
                debugOrientationDefault.textContent = defaultOrientation;
            }

            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener("deviceorientationabsolute", onHeadingChange, true);
            } else {
                window.addEventListener("deviceorientation", onHeadingChange, true);
            }

            document.addEventListener("fullscreenchange", onFullscreenChange);
            document.addEventListener("webkitfullscreenchange", onFullscreenChange);
            document.addEventListener("mozfullscreenchange", onFullscreenChange);
            document.addEventListener("MSFullscreenChange", onFullscreenChange);

            btnLockOrientation.addEventListener("click", toggleOrientationLock);
            btnNightmode.addEventListener("click", openHome);
            btnMap.addEventListener("click", openMap);

            var i;
            for (i=0; i<btnsPopup.length; i++) {
                btnsPopup[i].addEventListener("click", popupOpenFromClick);
            }

            popup.addEventListener("click", popupClose);
            popupContents.addEventListener("click", popupContentsClick);

            navigator.geolocation.watchPosition(locationUpdate, locationUpdateFail, {
                enableHighAccuracy: false,
                maximumAge: 30000,
                timeout: 27000
            });

            setNightmode(false);
            checkLockable();

        }());
    </script>
</body>
</html>
