<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qibla Finder - Islamic Prayer Times</title>
    <meta name="description" content="Find accurate direction to Mecca with compass.">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Islamic Style -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Islamic Prayer Times App - Custom Styles */
        :root {
            --islamic-green: #2d5a3d;
            --islamic-green-light: #4a8061;
            --islamic-gold: #d4af37;
            --islamic-gold-light: #f4d03f;
            --text-dark: #2c3e50;
            --text-light: #ecf0f1;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --gradient-green: linear-gradient(135deg, var(--islamic-green), var(--islamic-green-light));
            --gradient-gold: linear-gradient(135deg, var(--islamic-gold), var(--islamic-gold-light));
        }

        /* Base Styles */
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding-top: 76px;
        }

        .arabic-font {
            font-family: 'Amiri', serif;
            font-weight: 700;
        }

        /* Navigation */
        .bg-islamic-green {
            background: var(--gradient-green) !important;
            box-shadow: 0 2px 20px var(--shadow-medium);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .navbar-nav .nav-link {
            font-weight: 500;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
            border-radius: 25px;
            padding: 0.5rem 1rem !important;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Section Header */
        .section-header {
            margin-bottom: 3rem;
        }

        .section-header h1 {
            color: var(--islamic-green);
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Qibla Compass */
        .qibla-compass {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 30px var(--shadow-light);
            margin-bottom: 2rem;
        }

        /* Compass Styles from the provided code */
        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }

        .compass {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
        }

        .compass__rose {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .compass__rose__dial {
            height: 100%;
            width: 100%;
        }

        .compass__pointer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100%;
            width: 100%;
        }

        /* Status panel styling */
        .status-panel {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px var(--shadow-light);
            margin-bottom: 2rem;
        }

        .position-data {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 768px) {
            .position-data {
                grid-template-columns: 1fr;
            }
        }

        .data-item {
            margin-bottom: 10px;
        }

        .label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--islamic-green);
        }

        /* Buttons */
        .btn-primary {
            background: var(--gradient-green);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--gradient-gold);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-medium);
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-compass {
            background: var(--gradient-green);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-compass:hover {
            background: var(--gradient-gold);
            transform: translateY(-2px);
        }

        .btn-compass:active {
            transform: translateY(0);
        }

        .icon {
            width: 20px;
            height: 20px;
        }

        /* Permission request */
        .permission-request {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px var(--shadow-light);
        }

        .accuracy-warning {
            text-align: center;
            color: #dc3545;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .qibla-direction {
            text-align: center;
            font-size: 1.5rem;
            margin: 20px 0;
            color: var(--islamic-gold);
            font-weight: bold;
        }

        /* Footer */
        footer {
            background: var(--gradient-green) !important;
            margin-top: 3rem;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.3s ease;
            margin: 0 10px;
            font-size: 0.9rem;
        }

        .footer-links a:hover {
            color: white;
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-top: 76px;
            }
            
            .compass-container {
                width: 250px;
                height: 250px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-compass {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-islamic-green fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-mosque me-2"></i>
                Islamic Prayer Times
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="prayer-times.html">Prayer Times</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mosque-finder.html">Mosque Finder</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="qibla.html">Qibla Finder</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dhikr.html">Dhikr Counter</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container py-5">
            <div class="section-header text-center">
                <h1><i class="fas fa-compass me-3"></i>Qibla Finder</h1>
                <p class="lead">Find accurate direction to Mecca with compass</p>
            </div>

            <!-- Qibla Compass Section -->
            <div class="qibla-compass">
                <h4 class="mb-4">Direction to Mecca</h4>
                
                <div class="compass-container">
                    <div class="compass">
                        <div id="rose" class="compass__rose">
                            <svg class="compass__rose__dial" viewBox="0 0 130 130" version="1.1" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="65" cy="65" r="50" stroke="silver" stroke-width="5" fill="none" />
                                <polyline points="62,13  68,13  65,23" fill="silver"/>
                                <polyline points="117,63  117,67  110,65" fill="silver"/>
                                <polyline points="63,117  67,117  65,110" fill="silver"/>
                                <polyline points="13,63  13,67  20,65" fill="silver"/>
                                <text x="65" y="4.2" font-size="9" text-anchor="middle" fill="#2d5a3d">N</text>
                                <text x="127" y="67" font-size="9" text-anchor="middle" fill="#2d5a3d">E</text>
                                <text x="65" y="129" font-size="9" text-anchor="middle" fill="#2d5a3d">S</text>
                                <text x="2.8" y="67" font-size="9" text-anchor="middle" fill="#2d5a3d">W</text>
                                <image id="kabah" x="55" y="15" width="30" height="30" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDMwIDMwIj48cGF0aCBkPSJNMTUsMyBMMjcsMTUgTDE1LDI3IEwzLDE1IFoiIGZpbGw9IiNiNjAwMDAiLz48L3N2Zz4=" />
                            </svg>
                        </div>
                        <svg class="compass__pointer" viewBox="0 0 130 130" version="1.1" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="56,65  74,65  65,19" fill="#b60000"/>
                            <polyline points="56,65  74,65  65,111" fill="white"/>
                            <circle cx="65" cy="65" r="5" stroke="#b60000" stroke-width="0" fill="black" />
                        </svg>
                    </div>
                </div>
                
                <div class="qibla-direction" id="qibla-direction">
                    Point your device toward Qibla
                </div>
            </div>

            <!-- Status Panel -->
            <div class="status-panel">
                <div class="position-data">
                    <div class="data-item">
                        <div class="label">Compass Direction</div>
                        <div class="value" id="position-hng">n/a</div>
                    </div>
                    <div class="data-item">
                        <div class="label">Qibla Direction</div>
                        <div class="value" id="position-qib">n/a</div>
                    </div>
                    <div class="data-item">
                        <div class="label">Latitude</div>
                        <div class="value" id="position-lat">&#8943;</div>
                    </div>
                    <div class="data-item">
                        <div class="label">Longitude</div>
                        <div class="value" id="position-lng">&#8943;</div>
                    </div>
                </div>
            </div>

            <div class="accuracy-warning">
                For best results, calibrate your compass by moving your device in a figure-8 motion
            </div>

            <div class="permission-request" id="permission-request">
                <p>This app needs access to your location and device orientation to work properly.</p>
                <button class="btn btn-primary" id="enable-btn">
                    <i class="fas fa-compass me-2"></i>Enable Sensors
                </button>
            </div>

            <div class="controls">
                <button class="btn-compass" id="recalibrate-btn">
                    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill="white" d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
                    </svg>
                    Recalibrate
                </button>
                <button class="btn-compass" id="night-mode-btn">
                    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill="white" d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/>
                    </svg>
                    Night Mode
                </button>
                <button class="btn-compass" id="info-btn">
                    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path fill="white" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                    </svg>
                    Info
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-islamic-green text-white py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0 arabic-font">"وَأَقِيمُوا الصَّلَاةَ وَآتُوا الزَّكَاةَ وَارْكَعُوا مَعَ الرَّاكِعِينَ"</p>
                    <small class="text-light">"And establish prayer and give zakah and bow with those who bow." - Quran 2:43</small>
                </div>
                <div class="col-md-6 text-md-end footer-links">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms of Service</a>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#disclaimerModal">Disclaimer</a>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#cookiesModal">Cookie Policy</a>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#contactModal">Contact Us</a>
                    <small>&copy; 2025 Islamic Prayer Times App</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Legal Modals -->
    <!-- Privacy Policy Modal -->
    <div class="modal fade legal-modal" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="privacyModalLabel"><i class="fas fa-shield-alt me-2"></i>Privacy Policy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Privacy Policy content -->
                    <h5>1. Information We Collect</h5>
                    <p>Our Islamic Prayer Times app collects limited information to provide you with accurate prayer times and mosque locations:</p>
                    <ul>
                        <li><strong>Location Data:</strong> We collect your device's geographical coordinates to calculate accurate prayer times and find nearby mosques.</li>
                        <li><strong>Usage Data:</strong> We may collect information about how you interact with our app to improve user experience.</li>
                        <li><strong>Device Information:</strong> We collect device type and browser information for compatibility purposes.</li>
                    </ul>
                    <!-- Rest of the privacy policy content -->
                    <p class="mt-4"><strong>Last Updated:</strong> January 1, 2025</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other modals (Terms, Disclaimer, Cookies, Contact) would go here -->
    <!-- Terms of Service Modal -->
    <div class="modal fade legal-modal" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel"><i class="fas fa-file-contract me-2"></i>Terms of Service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Terms of Service content -->
                    <h5>1. Acceptance of Terms</h5>
                    <p>By accessing and using the Islamic Prayer Times app, you accept and agree to be bound by the terms and provision of this agreement.</p>
                    <!-- Rest of the terms content -->
                    <p class="mt-4"><strong>Last Updated:</strong> January 1, 2025</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div class="modal fade legal-modal" id="disclaimerModal" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="disclaimerModalLabel"><i class="fas fa-exclamation-circle me-2"></i>Disclaimer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Disclaimer content -->
                    <h5>1. Prayer Times Accuracy</h5>
                    <p>The prayer times provided by this app are calculated using established mathematical formulas and are based on your geographical location.</p>
                    <!-- Rest of the disclaimer content -->
                    <p class="mt-4"><strong>Last Updated:</strong> January 1, 2025</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cookie Policy Modal -->
    <div class="modal fade legal-modal" id="cookiesModal" tabindex="-1" aria-labelledby="cookiesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cookiesModalLabel"><i class="fas fa-cookie-bite me-2"></i>Cookie Policy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Cookie Policy content -->
                    <h5>1. What Are Cookies</h5>
                    <p>Cookies are small text files that are stored on your device when you visit websites or use web applications.</p>
                    <!-- Rest of the cookie policy content -->
                    <p class="mt-4"><strong>Last Updated:</strong> January 1, 2025</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal fade legal-modal" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel"><i class="fas fa-envelope me-2"></i>Contact Us</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <h5>Get In Touch</h5>
                    <p>We're here to assist you with any questions about prayer times, mosque locations, or technical support for our app.</p>
                    <div class="row justify-content-center mt-4">
                        <div class="col-md-8">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="contact-icon mb-3">
                                        <i class="fas fa-envelope fa-2x text-primary"></i>
                                    </div>
                                    <h5>Email Support</h5>
                                    <p>Send us an email for assistance with the app or prayer time calculations</p>
                                    <a href="mailto:kindnesspath1@gmail.com" class="btn btn-primary mt-2">
                                        <i class="fas fa-paper-plane me-2"></i>Send Email
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Qibla Compass Script -->
    <script>
        (function () {
            "use strict";

            // Set to true for debugging output
            var debug = false;

            // Our current position
            var positionCurrent = {
                lat: null,
                lng: null,
                hng: null
            };
            
            var roundedCurlat, roundedCurlon;

            // Qibla direction var
            let pointDegree;

            // Location info
            var city, state, country;

            // The outer part of the compass that rotates
            var rose = document.getElementById("rose");

            // Elements that output our position
            var positionLat = document.getElementById("position-lat");
            var positionLng = document.getElementById("position-lng");
            var positionHng = document.getElementById("position-hng");
            var positionQib = document.getElementById("position-qib");
            var qiblaDirection = document.getElementById("qibla-direction");

            // Permission request elements
            var permissionRequest = document.getElementById("permission-request");
            var enableBtn = document.getElementById("enable-btn");
            var recalibrateBtn = document.getElementById("recalibrate-btn");
            var nightModeBtn = document.getElementById("night-mode-btn");
            var infoBtn = document.getElementById("info-btn");
            var kabah = document.getElementById("kabah");

            // If we have shown the heading unavailable warning yet
            var warningHeadingShown = false;

            // Switches keeping track of our current app state
            var isOrientationLockable = false;
            var isOrientationLocked = false;
            var isNightMode = false;

            // The orientation of the device on app load
            var defaultOrientation;

            // Request permissions and start the app
            enableBtn.addEventListener('click', () => {
                requestPermissions();
            });

            // Recalibrate compass
            recalibrateBtn.addEventListener('click', () => {
                alert('Please move your device in a figure-8 motion to calibrate the compass.');
            });

            // Toggle night mode
            nightModeBtn.addEventListener('click', () => {
                isNightMode = !isNightMode;
                document.body.classList.toggle('nightmode', isNightMode);
                nightModeBtn.innerHTML = isNightMode 
                    ? '<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="white" d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-9 7.25c0-.55.45-1 1-1h4c.55 0 1 .45 1 1s-.45 1-1 1H4c-.55 0-1-.45-1-1z"/></svg>Day Mode'
                    : '<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="white" d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>Night Mode';
            });

            // Show info
            infoBtn.addEventListener('click', () => {
                alert('Qibla Compass: This tool helps you find the direction to Mecca (Qibla) using your device\'s compass and location services. For accurate results, make sure to enable location services and calibrate your compass by moving your device in a figure-8 motion.');
            });

            // Browser agnostic orientation
            function getBrowserOrientation() {
                var orientation;
                if (screen.orientation && screen.orientation.type) {
                    orientation = screen.orientation.type;
                } else {
                    orientation = screen.orientation ||
                                screen.mozOrientation ||
                                screen.msOrientation;
                }
                return orientation;
            }

            // Called on device orientation change
            function onHeadingChange(event) {
                var heading = -1*event.webkitCompassHeading || event.alpha;
                var alpha;
                var orientation = getBrowserOrientation();

                if (typeof heading !== "undefined" && heading !== null) {
                    // We have a browser that reports device heading and orientation

                    if (debug) {
                        console.log("Orientation: " + orientation);
                    }

                    // What adjustment we have to add to rotation to allow for current device orientation
                    var adjustment = 0;
                    if (defaultOrientation === "landscape") {
                        adjustment -= 90;
                    }

                    if (typeof orientation !== "undefined") {
                        var currentOrientation = orientation.split("-");

                        if (defaultOrientation !== currentOrientation[0]) {
                            if (defaultOrientation === "landscape") {
                                adjustment -= 270;
                            } else {
                                adjustment -= 90;
                            }
                        }

                        if (currentOrientation[1] === "secondary") {
                            adjustment -= 180;
                        }
                    }

                    positionCurrent.hng = heading - window.orientation;// + adjustment;

                    var phase = positionCurrent.hng < 0 ? 360 + positionCurrent.hng : positionCurrent.hng;
                    positionHng.textContent = (360 - phase | 0) + "°";
                    
                    // Indicate heading near Qibla
                    var qiboffset = Math.abs((360 - phase) - pointDegree);
                    if(qiboffset < 15) {
                        alpha = (15 - qiboffset) / 15;
                        positionHng.style.background = "rgba(200,0,0,"+alpha+")";
                        kabah.style.background = "rgba(170,0,0,"+alpha+")";
                        qiblaDirection.innerHTML = "&#128331; Qibla Direction Found &#128332;";
                        qiblaDirection.style.color = "rgba(92, 184, 92, " + alpha + ")";
                    } else {
                        qiblaDirection.style.color = "#d4af37";
                        qiblaDirection.innerHTML = "Point your device toward Qibla";
                        positionHng.style.background = "none";
                    }

                    // Apply rotation to compass rose
                    if (typeof rose.style.transform !== "undefined") {
                        rose.style.transform = "rotateZ(" + positionCurrent.hng + "deg)";
                    } else if (typeof rose.style.webkitTransform !== "undefined") {
                        rose.style.webkitTransform = "rotateZ(" + positionCurrent.hng + "deg)";
                    }
                } else {
                    // Device can't show heading
                    positionHng.textContent = "n/a";
                    showHeadingWarning();
                }
            }

            function showHeadingWarning() {
                if (!warningHeadingShown) {
                    alert('Unable to access device orientation. Please make sure your device has a compass and you\'ve granted the necessary permissions.');
                    warningHeadingShown = true;
                }
            }

            // Request necessary permissions
            function requestPermissions() {
                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by your browser');
                    return;
                }
                
                // Request location access
                navigator.geolocation.getCurrentPosition(
                    position => {
                        // Request device orientation access
                        if (typeof DeviceOrientationEvent !== 'undefined' && 
                            typeof DeviceOrientationEvent.requestPermission === 'function') {
                            DeviceOrientationEvent.requestPermission()
                                .then(permissionState => {
                                    if (permissionState === 'granted') {
                                        startApp(position);
                                    } else {
                                        alert('Device orientation permission is required for the compass to work.');
                                    }
                                })
                                .catch(console.error);
                        } else {
                            startApp(position);
                        }
                    },
                    error => {
                        alert('Unable to access your location. Please check your location settings.');
                        console.error('Geolocation error:', error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            }

            // Start the application
            function startApp(position) {
                permissionRequest.style.display = 'none';
                
                // Initialize with current position
                updateLocation(position);
                
                // Watch for position changes
                navigator.geolocation.watchPosition(
                    updateLocation,
                    console.error,
                    { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
                );
                
                // Listen for device orientation changes
                if (typeof DeviceOrientationEvent !== 'undefined') {
                    window.addEventListener('deviceorientation', onHeadingChange);
                } else {
                    alert('Device orientation is not supported on your device.');
                }
            }

            // Update location and calculate Qibla direction
            function updateLocation(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                positionLat.textContent = lat.toFixed(6);
                positionLng.textContent = lng.toFixed(6);
                
                // Calculate Qibla direction
                pointDegree = calculateQiblaDirection(lat, lng);
                positionQib.textContent = Math.round(pointDegree) + '°';
                
                // Update Kabah position on compass
                updateKabahPosition(pointDegree);
            }

            // Calculate Qibla direction based on current location
            function calculateQiblaDirection(lat, lng) {
                // Mecca coordinates
                const meccaLat = 21.422487;
                const meccaLng = 39.826206;
                
                const phiK = (meccaLat * Math.PI) / 180.0;
                const lambdaK = (meccaLng * Math.PI) / 180.0;
                const phi = (lat * Math.PI) / 180.0;
                const lambda = (lng * Math.PI) / 180.0;
                
                const psi = (180.0 / Math.PI) * Math.atan2(
                    Math.sin(lambdaK - lambda),
                    Math.cos(phi) * Math.tan(phiK) - 
                    Math.sin(phi) * Math.cos(lambdaK - lambda)
                );
                
                return (psi + 360) % 360; // Ensure positive value
            }

            // Update Kabah position on the compass
            function updateKabahPosition(degree) {
                const circle = document.querySelector('circle');
                const svgr = parseInt(circle.getAttribute('r'));
                const cx = parseInt(circle.getAttribute('cx'));
                const cy = parseInt(circle.getAttribute('cy'));
                const kw = parseInt(kabah.getAttribute('width'));
                const kh = parseInt(kabah.getAttribute('height'));
                
                const kx = Math.sin(degree * Math.PI / 180) * svgr + cx - (kw / 2);
                const ky = -Math.cos(degree * Math.PI / 180) * svgr + cy - (kh / 2);
                
                kabah.setAttribute('x', kx);
                kabah.setAttribute('y', ky);
                kabah.setAttribute('transform', `rotate(${degree}, ${kx + (kw/2)}, ${ky + (kh/2)})`);
            }

            // Initialize device orientation
            if (screen.width > screen.height) {
                defaultOrientation = "landscape";
            } else {
                defaultOrientation = "portrait";
            }

            // Initialize with a demo if permissions are not granted
            setTimeout(() => {
                if (permissionRequest.style.display !== 'none') {
                    // Demo mode with sample data
                    positionLat.textContent = '21.422487';
                    positionLng.textContent = '39.826206';
                    positionQib.textContent = '0°';
                    positionHng.textContent = '0°';
                    updateKabahPosition(0);
                }
            }, 5000);

        }());
    </script>
</body>
</html>
