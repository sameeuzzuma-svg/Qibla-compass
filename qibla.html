<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2d5a3d">
    <meta name="description" content="Find accurate Qibla direction to Mecca with modern compass technology and Islamic design.">
    <title>Qibla Finder - Islamic Prayer Direction Compass</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Islamic Style -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Islamic Theme Variables */
        :root {
            --islamic-green: #2d5a3d;
            --islamic-green-light: #4a8061;
            --islamic-gold: #d4af37;
            --islamic-gold-light: #f4d03f;
            --text-dark: #2c3e50;
            --text-light: #ecf0f1;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --gradient-green: linear-gradient(135deg, var(--islamic-green), var(--islamic-green-light));
            --gradient-gold: linear-gradient(135deg, var(--islamic-gold), var(--islamic-gold-light));
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--text-dark);
            min-height: 100vh;
            padding-top: 80px;
        }

        .arabic-font {
            font-family: 'Amiri', serif;
            font-weight: 700;
        }

        /* Header Styles */
        header {
            background: var(--gradient-green);
            color: white;
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px var(--shadow-medium);
            transition: transform 0.5s ease-out;
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        header p {
            font-size: 0.9rem;
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            line-height: 1.4;
        }

        /* Container and Layout */
        .container {
            padding: 2rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            min-height: calc(100vh - 160px);
            transition: transform 0.5s ease-out;
        }

        /* Compass Styles */
        .compass-wrapper {
            background: white;
            border-radius: 25px;
            padding: 2rem;
            box-shadow: 0 15px 35px var(--shadow-light);
            border: 1px solid rgba(45, 90, 61, 0.1);
            margin: 2rem 0;
        }

        .compass {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 0 auto;
            text-align: center;
        }

        .compass__rose {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: transform 0.3s ease-out;
        }

        .compass__rose__dial {
            height: 100%;
            width: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at center, #ffffff 0%, #f8f9fa 70%, #e9ecef 100%);
            box-shadow: inset 0 0 20px rgba(45, 90, 61, 0.1);
        }

        .compass__pointer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            height: 100%;
            width: 100%;
        }

        /* Status Display */
        .status {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 10px 30px var(--shadow-light);
            border: 1px solid rgba(45, 90, 61, 0.1);
        }

        .position {
            text-align: center;
            margin-bottom: 1rem;
        }

        .position:last-child {
            margin-bottom: 0;
        }

        [class^="column-"] {
            display: inline-block;
            vertical-align: top;
            padding: 0 0.5rem;
            text-align: center;
        }

        .column-33 { width: 33.33%; }
        .column-25 { width: 25%; }
        .column-20 { width: 20%; }
        .column-50 { width: 50%; }

        .label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--islamic-green);
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .position div:not(.label) {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        #position-lab {
            font-size: 1rem;
            color: var(--islamic-gold);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Button Styles */
        .options {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            border: 2px solid var(--islamic-green);
            color: var(--islamic-green);
            background: transparent;
            cursor: pointer;
            text-align: center;
            padding: 0.75rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover, .btn.active {
            background: var(--islamic-green);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-medium);
        }

        .btn--hide {
            display: none;
        }

        .btn--hide.show {
            display: inline-block;
        }

        .btn__icon {
            width: 24px;
            height: 24px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .btn__icon--active {
            display: none;
        }

        .btn__icon--inactive {
            display: inline-block;
        }

        .btn.active .btn__icon--active {
            display: inline-block;
        }

        .btn.active .btn__icon--inactive {
            display: none;
        }

        /* Popup Styles */
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
        }

        .popup.popup--show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup__content {
            max-width: 500px;
            width: 90%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .popup__contents {
            padding: 2rem;
            line-height: 1.6;
        }

        .popup__contents h3 {
            color: var(--islamic-green);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .popup__contents p {
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .popup__contents a {
            color: var(--islamic-gold);
            text-decoration: none;
            font-weight: 600;
        }

        .popup__contents a:hover {
            text-decoration: underline;
        }

        .popup__close {
            display: block;
            width: 100%;
            padding: 1rem 2rem;
            background: var(--gradient-green);
            color: white;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup__close:hover {
            background: var(--gradient-gold);
        }

        /* Night Mode */
        html.nightmode {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
        }

        html.nightmode body {
            background: transparent;
            color: white;
        }

        html.nightmode .container {
            transform: translateY(-2rem);
        }

        html.nightmode header {
            transform: translateY(-4rem);
        }

        html.nightmode .compass-wrapper,
        html.nightmode .status {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        html.nightmode .compass__rose__dial {
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 70%, rgba(0, 0, 0, 0.1) 100%);
        }

        html.nightmode .label {
            color: rgba(212, 175, 55, 0.8);
        }

        html.nightmode .position div:not(.label) {
            color: white;
        }

        html.nightmode .btn {
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
        }

        html.nightmode .btn:hover,
        html.nightmode .btn.active {
            background: rgba(45, 90, 61, 0.8);
            border-color: var(--islamic-green);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-top: 70px;
            }
            
            .compass {
                width: 280px;
                height: 280px;
            }
            
            .compass-wrapper {
                padding: 1.5rem;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            header p {
                font-size: 0.8rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            [class^="column-"] {
                margin-bottom: 1rem;
            }
            
            .column-33,
            .column-25,
            .column-20 {
                width: 50%;
            }
        }

        @media (max-width: 576px) {
            .compass {
                width: 240px;
                height: 240px;
            }
            
            [class^="column-"] {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        /* Debug styles (hidden by default) */
        #debug-orientation,
        #debug-orientation-default {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>
            <i class="fas fa-kaaba"></i>
            Qibla Direction Finder
        </h1>
        <p id="intro">Find accurate direction to Mecca using your device's compass. This Islamic compass app helps you determine the Qibla direction for prayer from your current location with precision and devotion.</p>
    </header>

    <div class="container">
        <div class="compass-wrapper">
            <div class="compass">
                <div id="rose" class="compass__rose">
                    <svg class="compass__rose__dial" viewBox="0 0 130 130" version="1.1" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="65" cy="65" r="50" stroke="#2d5a3d" stroke-width="4" fill="none" />
                        <!-- North marker -->
                        <polyline points="62,13  68,13  65,23" fill="#2d5a3d"/>
                        <!-- East marker -->
                        <polyline points="117,63  117,67  110,65" fill="#2d5a3d"/>
                        <!-- South marker -->
                        <polyline points="63,117  67,117  65,110" fill="#2d5a3d"/>
                        <!-- West marker -->
                        <polyline points="13,63  13,67  20,65" fill="#2d5a3d"/>
                        <!-- Cardinal labels -->
                        <text x="65" y="8" font-size="12" text-anchor="middle" fill="#2d5a3d" font-weight="bold">N</text>
                        <text x="123" y="69" font-size="12" text-anchor="middle" fill="#2d5a3d" font-weight="bold">E</text>
                        <text x="65" y="126" font-size="12" text-anchor="middle" fill="#2d5a3d" font-weight="bold">S</text>
                        <text x="7" y="69" font-size="12" text-anchor="middle" fill="#2d5a3d" font-weight="bold">W</text>
                        <!-- Kaaba icon positioned at Qibla direction -->
                        <g id="kabah" transform="translate(50, 10)">
                            <rect x="0" y="5" width="30" height="20" fill="#d4af37" rx="2"/>
                            <rect x="2" y="7" width="26" height="16" fill="#b8941f" rx="1"/>
                            <circle cx="15" cy="15" r="3" fill="#2d5a3d"/>
                            <text x="15" y="32" font-size="8" text-anchor="middle" fill="#2d5a3d" font-weight="bold">KAABA</text>
                        </g>
                    </svg>
                </div>
                <svg class="compass__pointer" viewBox="0 0 130 130" version="1.1" xmlns="http://www.w3.org/2000/svg">
                    <!-- North pointer (gold) -->
                    <polyline points="56,65  74,65  65,19" fill="#d4af37"/>
                    <!-- South pointer (white) -->
                    <polyline points="56,65  74,65  65,111" fill="rgba(255, 255, 255, 0.8)"/>
                    <!-- Center dot -->
                    <circle cx="65" cy="65" r="5" stroke="#2d5a3d" stroke-width="2" fill="white" />
                </svg>
            </div>
        </div>

        <div class='status'>
            <!-- Hidden debug elements -->
            <div id='debug-orientation-default' style="display: none;"></div>
            <div id='debug-orientation' style="display: none;"></div>

            <div class='position row'>
                <div id='position-lab'>Detecting your location...</div>
            </div>
            
            <div class='position row'>
                <div class='column-25'>
                    <div class='label'><i class="fas fa-compass"></i> Compass</div>
                    <div id='position-hng'>Calibrating...</div>
                </div>
                <div class='column-25'>
                    <div class='label'><i class="fas fa-kaaba"></i> Qibla</div>
                    <div id='position-qib'>Calculating...</div>
                </div>
                <div class='column-25'>
                    <div class='label'><i class="fas fa-map-marker-alt"></i> Latitude</div>
                    <div id='position-lat'>&#8943;</div>
                </div>
                <div class='column-25'>
                    <div class='label'><i class="fas fa-map-marker-alt"></i> Longitude</div>
                    <div id='position-lng'>&#8943;</div>
                </div>
            </div>

            <div class="options">
                <button id="btn-lock-orientation" class="btn btn--hide" type="button">
                    <i class="fas fa-unlock btn__icon btn__icon--inactive"></i>
                    <i class="fas fa-lock btn__icon btn__icon--active"></i>
                    <span>Lock</span>
                </button>
                <button id="btn-nightmode" class="btn" type="button">
                    <i class="fas fa-moon btn__icon btn__icon--inactive"></i>
                    <i class="fas fa-sun btn__icon btn__icon--active"></i>
                    <span>Night Mode</span>
                </button>
                <button id="btn-map" class="btn" type="button">
                    <i class="fas fa-map btn__icon btn__icon--inactive"></i>
                    <span>Map</span>
                </button>
                <button id="btn-info" class="btn btn-popup" type="button" data-name='info'>
                    <i class="fas fa-info-circle btn__icon btn__icon--inactive"></i>
                    <span>Info</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Popup -->
    <div id="popup" class="popup">
        <div id="popup-content" class="popup__content">
            <div id="popup-contents" class="popup__contents">
                <div id="popup-inner-info" class="popup__inner">
                    <h3><i class="fas fa-kaaba me-2"></i>Qibla Direction Compass</h3>
                    <p>
                        This <strong>Qibla Direction Compass</strong> shows the current qibla direction using your device's compass. The app utilizes your geographical location and device sensors to find the accurate direction to the Kaaba in Mecca.
                    </p>
                    <p>
                        <strong>For best results:</strong>
                    </p>
                    <ul>
                        <li>Stay away from magnets, metals, and electronic devices</li>
                        <li>Calibrate your compass by moving the device in a figure-8 pattern</li>
                        <li>Hold your device flat and parallel to the ground</li>
                        <li>Ensure location services are enabled</li>
                    </ul>
                    <p class="arabic-font" style="text-align: center; font-size: 1.2rem; color: var(--islamic-green); margin: 1rem 0;">
                        "فَوَلِّ وَجْهَكَ شَطْرَ الْمَسْجِدِ الْحَرَامِ"
                    </p>
                    <p style="text-align: center; font-style: italic; color: #666;">
                        "Turn your face toward the Sacred Mosque" - Quran 2:144
                    </p>
                </div>
                <div id="popup-inner-noorientation" class="popup__inner popup__inner--hide">
                    <h3><i class="fas fa-exclamation-triangle me-2"></i>Device Not Supported</h3>
                    <p>Unfortunately, your device does not support compass functionality or we cannot detect location services.</p>
                    <p>
                        <strong>Alternative methods:</strong>
                    </p>
                    <ul>
                        <li>Use a smartphone or tablet with magnetometer sensors</li>
                        <li>Enable location services in your browser</li>
                        <li>Try refreshing the page and granting permissions</li>
                    </ul>
                </div>
            </div>
            <button id="popup-close" class="popup__close">
                <i class="fas fa-times me-2"></i>Close
            </button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        (function () {
            "use strict";

            // Set to true for debugging output
            var debug = false;

            // Kaaba coordinates
            var KAABA_LAT = 21.422487;
            var KAABA_LNG = 39.826206;

            // Our current position
            var positionCurrent = {
                lat: null,
                lng: null,
                hng: null
            };
            
            var roundedCurlat, roundedCurlon;

            // Intro text
            var intro = document.getElementById("intro");
            var introtext = intro.innerHTML;

            // Qibla direction var
            let pointDegree;

            // Location info
            var city, state, country;

            // The outer part of the compass that rotates
            var rose = document.getElementById("rose");

            // Elements that output our position
            var positionLat = document.getElementById("position-lat");
            var positionLng = document.getElementById("position-lng");
            var positionHng = document.getElementById("position-hng");
            var positionQib = document.getElementById("position-qib");
            var positionLab = document.getElementById("position-lab");

            // Debug outputs
            var debugOrientation = document.getElementById("debug-orientation");
            var debugOrientationDefault = document.getElementById("debug-orientation-default");

            // Info popup elements, plus buttons that open popups
            var popup = document.getElementById("popup");
            var popupContents = document.getElementById("popup-contents");
            var popupInners = document.querySelectorAll(".popup__inner");
            var btnsPopup = document.querySelectorAll(".btn-popup");

            // Buttons at the bottom of the screen
            var btnLockOrientation = document.getElementById("btn-lock-orientation");
            var btnNightmode = document.getElementById("btn-nightmode");
            var btnMap = document.getElementById("btn-map");
            var btnInfo = document.getElementById("btn-info");

            // If we have shown the heading unavailable warning yet
            var warningHeadingShown = false;

            // Switches keeping track of our current app state
            var isOrientationLockable = false;
            var isOrientationLocked = false;
            var isNightMode = false;

            // The orientation of the device on app load
            var defaultOrientation;

            // Browser agnostic orientation
            function getBrowserOrientation() {
                var orientation;
                if (screen.orientation && screen.orientation.type) {
                    orientation = screen.orientation.type;
                } else {
                    orientation = screen.orientation ||
                                screen.mozOrientation ||
                                screen.msOrientation;
                }
                return orientation;
            }

            // Browser agnostic orientation unlock
            function browserUnlockOrientation() {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                } else if (screen.unlockOrientation) {
                    screen.unlockOrientation();
                } else if (screen.mozUnlockOrientation) {
                    screen.mozUnlockOrientation();
                } else if (screen.msUnlockOrientation) {
                    screen.msUnlockOrientation();
                }
            }

            // Called on device orientation change
            function onHeadingChange(event) {
                var heading = event.webkitCompassHeading || event.alpha;
                
                if (typeof heading !== "undefined" && heading !== null) {
                    // Handle different browser implementations
                    if (event.webkitCompassHeading !== undefined) {
                        // iOS Safari
                        heading = event.webkitCompassHeading;
                    } else if (event.alpha !== null) {
                        // Android Chrome and other browsers
                        heading = 360 - event.alpha;
                    }

                    // Normalize heading to 0-360 range
                    heading = (heading + 360) % 360;

                    // Handle device orientation adjustments
                    var orientation = getBrowserOrientation();
                    var adjustment = 0;

                    if (orientation) {
                        if (orientation.includes('landscape')) {
                            if (orientation.includes('secondary')) {
                                adjustment = 90;
                            } else {
                                adjustment = -90;
                            }
                        } else if (orientation.includes('portrait-secondary')) {
                            adjustment = 180;
                        }
                    }

                    // Apply adjustment and normalize
                    var finalHeading = (heading + adjustment + 360) % 360;
                    
                    // Store our current heading
                    positionCurrent.hng = Math.round(finalHeading);

                    // Apply rotation to compass rose (rotate opposite to heading to keep compass correct)
                    rose.style.transform = "rotate(" + (-finalHeading) + "deg)";

                    // Update heading display
                    positionHng.textContent = positionCurrent.hng + "°";

                    // Update Kaaba position if we have location
                    if (pointDegree !== undefined) {
                        updateKaabaPosition();
                    }

                } else {
                    // Device heading not available
                    positionHng.textContent = "n/a";
                    
                    // Show popup if we haven't already
                    if (!warningHeadingShown) {
                        warningHeadingShown = true;
                        showPopup("noorientation");
                    }
                }
            }

            // Update Kaaba position on compass
            function updateKaabaPosition() {
                if (pointDegree !== undefined) {
                    var kabah = document.getElementById("kabah");
                    if (kabah) {
                        // Calculate Kaaba position relative to current compass orientation
                        var kaabaAngle = pointDegree;
                        
                        // Position Kaaba icon around the compass circle
                        var radius = 45; // Distance from center
                        var centerX = 65;
                        var centerY = 65;
                        
                        // Convert angle to radians and calculate position
                        var radians = (kaabaAngle - 90) * Math.PI / 180; // -90 to start from top
                        var x = centerX + radius * Math.cos(radians) - 15; // -15 to center the 30px wide icon
                        var y = centerY + radius * Math.sin(radians) - 15; // -15 to center the 30px tall icon
                        
                        kabah.setAttribute("transform", "translate(" + x + ", " + y + ")");
                    }
                }
            }

            // Called on device position change
            function onPositionChange(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;

                // Store our current position
                positionCurrent.lat = lat;
                positionCurrent.lng = lng;

                // Round for display
                roundedCurlat = Math.round(lat * 10000) / 10000;
                roundedCurlon = Math.round(lng * 10000) / 10000;

                // Update position display
                positionLat.textContent = roundedCurlat + "°";
                positionLng.textContent = roundedCurlon + "°";

                // Calculate qibla direction
                pointDegree = calculateQiblaDirection(lat, lng);
                positionQib.textContent = pointDegree + "°";

                // Update status
                positionLab.textContent = "Location detected - Compass ready";

                // Update Kaaba position
                updateKaabaPosition();

                // Get location details using reverse geocoding
                getReverseGeocoding(lat, lng);
            }

            // Calculate qibla direction using spherical trigonometry
            function calculateQiblaDirection(lat, lng) {
                // Convert to radians
                var lat1 = lat * Math.PI / 180;
                var lng1 = lng * Math.PI / 180;
                var lat2 = KAABA_LAT * Math.PI / 180;
                var lng2 = KAABA_LNG * Math.PI / 180;

                var dlng = lng2 - lng1;

                var y = Math.sin(dlng) * Math.cos(lat2);
                var x = (Math.cos(lat1) * Math.sin(lat2)) - (Math.sin(lat1) * Math.cos(lat2) * Math.cos(dlng));

                var bearing = Math.atan2(y, x);
                bearing = bearing * 180 / Math.PI;
                bearing = (bearing + 360) % 360;

                return Math.round(bearing);
            }

            // Get location details using reverse geocoding
            function getReverseGeocoding(lat, lng) {
                fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`)
                    .then(response => response.json())
                    .then(data => {
                        city = data.city || data.locality || 'Unknown';
                        country = data.countryName || 'Unknown';
                        positionLab.textContent = `${city}, ${country}`;
                    })
                    .catch(error => {
                        console.error('Error getting location details:', error);
                        positionLab.textContent = `${roundedCurlat}°, ${roundedCurlon}°`;
                    });
            }

            // Called on device position error
            function onPositionError(error) {
                positionLab.textContent = "Location access denied or unavailable";
                console.error("Position error:", error);
            }

            // Show popup
            function showPopup(name) {
                // Hide all popup inners
                popupInners.forEach(function(inner) {
                    inner.classList.add("popup__inner--hide");
                });

                // Show the requested popup inner
                var popupInner = document.getElementById("popup-inner-" + name);
                if (popupInner) {
                    popupInner.classList.remove("popup__inner--hide");
                }

                // Show the popup
                popup.classList.add("popup--show");
            }

            // Hide popup
            function hidePopup() {
                popup.classList.remove("popup--show");
            }

            // Toggle night mode
            function toggleNightMode() {
                isNightMode = !isNightMode;
                if (isNightMode) {
                    document.documentElement.classList.add("nightmode");
                    btnNightmode.classList.add("active");
                } else {
                    document.documentElement.classList.remove("nightmode");
                    btnNightmode.classList.remove("active");
                }
            }

            // Toggle orientation lock
            function toggleOrientationLock() {
                if (isOrientationLocked) {
                    browserUnlockOrientation();
                    btnLockOrientation.classList.remove("active");
                    isOrientationLocked = false;
                } else {
                    // Lock to current orientation
                    var currentOrientation = getBrowserOrientation() || defaultOrientation + "-primary";
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock(currentOrientation).then(function() {
                            btnLockOrientation.classList.add("active");
                            isOrientationLocked = true;
                        }).catch(function() {
                            console.log("Orientation lock failed");
                        });
                    }
                }
            }

            // Open map
            function openMap() {
                if (positionCurrent.lat && positionCurrent.lng) {
                    var mapUrl = `https://www.google.com/maps?q=${positionCurrent.lat},${positionCurrent.lng}&z=15`;
                    window.open(mapUrl, '_blank');
                } else {
                    alert("Location not available. Please allow location access first.");
                }
            }

            // Event listeners
            document.addEventListener("DOMContentLoaded", function() {
                // Store default orientation
                defaultOrientation = getBrowserOrientation() || "portrait";

                if (debug) {
                    debugOrientationDefault.textContent = defaultOrientation;
                }

                // Check if orientation lock is available
                if (screen.orientation && screen.orientation.lock) {
                    isOrientationLockable = true;
                    btnLockOrientation.classList.add("show");
                }

                // Start watching device orientation
                if (window.DeviceOrientationEvent) {
                    // For iOS 13+, request permission first
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        DeviceOrientationEvent.requestPermission()
                            .then(response => {
                                if (response === 'granted') {
                                    window.addEventListener("deviceorientation", onHeadingChange);
                                } else {
                                    console.log('Device orientation permission denied');
                                    showPopup("noorientation");
                                }
                            })
                            .catch(console.error);
                    } else {
                        // For other browsers
                        window.addEventListener("deviceorientation", onHeadingChange);
                    }
                }

                // Start watching device position
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        onPositionChange,
                        onPositionError,
                        {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 30000
                        }
                    );
                } else {
                    positionLab.textContent = "Geolocation not supported";
                }
            });

            // Button event listeners
            btnNightmode.addEventListener("click", toggleNightMode);
            btnLockOrientation.addEventListener("click", toggleOrientationLock);
            btnMap.addEventListener("click", openMap);

            // Popup button listeners
            btnsPopup.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    var popupName = this.getAttribute("data-name");
                    showPopup(popupName);
                });
            });

            // Close popup listener
            document.getElementById("popup-close").addEventListener("click", hidePopup);

            // Close popup when clicking outside
            popup.addEventListener("click", function(e) {
                if (e.target === popup) {
                    hidePopup();
                }
            });

        })();
    </script>
</body>
</html>
