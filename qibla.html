<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qibla Compass</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .intro {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
        }
        
        .compass-rose, .compass-pointer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .status-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .position-data {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .data-item {
            margin-bottom: 10px;
        }
        
        .label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            background: #4a89dc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: #5d9cec;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .icon {
            width: 20px;
            height: 20px;
        }
        
        .permission-request {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .accuracy-warning {
            text-align: center;
            color: #ff6b6b;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .qibla-direction {
            text-align: center;
            font-size: 1.5rem;
            margin: 20px 0;
            color: #ffce54;
            font-weight: bold;
        }
        
        @media (max-width: 600px) {
            .position-data {
                grid-template-columns: 1fr;
            }
            
            .compass-container {
                width: 250px;
                height: 250px;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Qibla Compass</h1>
            <p class="intro">This application helps you find the direction to Qibla (Mecca) using your device's compass and location services.</p>
        </header>
        
        <div class="compass-container">
            <svg class="compass-rose" viewBox="0 0 130 130" xmlns="http://www.w3.org/2000/svg">
                <circle cx="65" cy="65" r="50" stroke="silver" stroke-width="5" fill="none" />
                <polyline points="62,13 68,13 65,23" fill="silver"/>
                <polyline points="117,63 117,67 110,65" fill="silver"/>
                <polyline points="63,117 67,117 65,110" fill="silver"/>
                <polyline points="13,63 13,67 20,65" fill="silver"/>
                <text x="65" y="4.2" font-size="9" text-anchor="middle" fill="white">N</text>
                <text x="127" y="67" font-size="9" text-anchor="middle" fill="white">E</text>
                <text x="65" y="129" font-size="9" text-anchor="middle" fill="white">S</text>
                <text x="2.8" y="67" font-size="9" text-anchor="middle" fill="white">W</text>
                <image id="kabah" x="55" y="15" width="30" height="30" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjYjYwMDAwIiBkPSJNNDQ2Ljc0IDM0MC42MmMtMS4yMDQtMTAuMTktNC4wOTItMTkuOTUtOC40OS0yOS4wN0w0MDAgMjQ1Ljg2YzEwLjgxLTE2Ljg4IDE3LjI2LTM3LjEgMTcuMjYtNTguMzYgMC01My42Ni00My42Ni05Ny4zMi05Ny4zMi05Ny4zMi01My42NiAwLTk3LjMyIDQzLjY2LTk3LjMyIDk3LjMyIDAgMjEuMjYgNi40NSA0MS40OCAxNy4yNiA1OC4zNmwtMzguMjUgNjUuN2MtNC4zOTkgOS4xMTktNy4yODYgMTguODgtOC40OSAyOS4wN0gwdjUwLjM1aDUxMlYzNDAuNjJINDQ2Ljc0eiIvPjxwYXRoIGZpbGw9IiNlYWVhZWEiIGQ9Ik0yNTYgOTAuMTRjLTUzLjY2IDAtOTcuMzIgNDMuNjYtOTcuMzIgOTcuMzIgMCAyMS4yNiA2LjQ1IDQxLjQ4IDE3LjI2IDU4LjM2bC0zOC4yNSA2NS43Yy00LjM5OSA5LjExOS03LjI4NiAxOC44OC04LjQ5IDI5LjA3aDI1Ni44MmMtMS4yMDQtMTAuMTktNC4wOTItMTkuOTUtOC40OS0yOS4wN2wtMzguMjUtNjUuN2MxMC44MS0xNi44OCAxNy4yNi0zNy4xIDE3LjI2LTU4LjM2IDAtNTMuNjYtNDMuNjYtOTcuMzItOTcuMzItOTcuMzJ6Ii8+PHBhdGggZmlsbD0iI2ZmY2U1NCIgZD0iTTM1My4yNiAxODcuNDZjMC01My42Ni00My42Ni05Ny4zMi05Ny4zMi05Ny4zMnMtOTcuMzIgNDMuNjYtOTcuMzIgOTcuMzIgOTcuMzIgMTYwLjY4IDk3LjMyIDE2MC42OCA5Ny4zMi0xMDcuMDIgOTcuMzItMTYwLjY4eiIvPjxwYXRoIGZpbGw9IiNiNjAwMDAiIGQ9Ik0yNTYgMTM1Ljg4YzI5LjM4IDAgNTMuMjYgMjMuODggNTMuMjYgNTMuMjZzLTIzLjg4IDUzLjI2LTUzLjI2IDUzLjI2LTUzLjI2LTIzLjg4LTUzLjI2LTUzLjI2IDIzLjg4LTUzLjI2IDUzLjI2LTUzLjI2eiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0yODYuODYgMTY1LjU4bC0xOC40MiA0Mi4xNiA0Mi4xNi0xOC40Mi0yMy43NC0yMy43NHoiLz48L3N2Zz4=" />
            </svg>
            
            <svg class="compass-pointer" viewBox="0 0 130 130" xmlns="http://www.w3.org/2000/svg">
                <polyline points="56,65 74,65 65,19" fill="#b60000"/>
                <polyline points="56,65 74,65 65,111" fill="white"/>
                <circle cx="65" cy="65" r="5" stroke="#b60000" stroke-width="0" fill="black" />
            </svg>
        </div>
        
        <div class="qibla-direction" id="qibla-direction">
            Point your device toward Qibla
        </div>
        
        <div class="status-panel">
            <div class="position-data">
                <div class="data-item">
                    <div class="label">Compass Direction</div>
                    <div class="value" id="position-hng">n/a</div>
                </div>
                <div class="data-item">
                    <div class="label">Qibla Direction</div>
                    <div class="value" id="position-qib">n/a</div>
                </div>
                <div class="data-item">
                    <div class="label">Latitude</div>
                    <div class="value" id="position-lat">&#8943;</div>
                </div>
                <div class="data-item">
                    <div class="label">Longitude</div>
                    <div class="value" id="position-lng">&#8943;</div>
                </div>
            </div>
        </div>
        
        <div class="accuracy-warning">
            For best results, calibrate your compass by moving your device in a figure-8 motion
        </div>
        
        <div class="permission-request" id="permission-request">
            <p>This app needs access to your location and device orientation to work properly.</p>
            <button id="enable-btn">Enable Sensors</button>
        </div>
        
        <div class="controls">
            <button id="recalibrate-btn">
                <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="white" d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
                </svg>
                Recalibrate
            </button>
            <button id="night-mode-btn">
                <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="white" d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/>
                </svg>
                Night Mode
            </button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // DOM Elements
            const positionHng = document.getElementById('position-hng');
            const positionQib = document.getElementById('position-qib');
            const positionLat = document.getElementById('position-lat');
            const positionLng = document.getElementById('position-lng');
            const qiblaDirection = document.getElementById('qibla-direction');
            const permissionRequest = document.getElementById('permission-request');
            const enableBtn = document.getElementById('enable-btn');
            const recalibrateBtn = document.getElementById('recalibrate-btn');
            const nightModeBtn = document.getElementById('night-mode-btn');
            const kabah = document.getElementById('kabah');
            const rose = document.querySelector('.compass-rose');
            
            // State variables
            let pointDegree = 0;
            let currentHeading = 0;
            let isNightMode = false;
            let isActive = false;
            
            // Coordinates of the Kaaba in Mecca
            const kaabaCoords = {
                lat: 21.422487,
                lng: 39.826206
            };
            
            // Request permissions and start the app
            enableBtn.addEventListener('click', () => {
                requestPermissions();
            });
            
            // Recalibrate compass
            recalibrateBtn.addEventListener('click', () => {
                alert('Please move your device in a figure-8 motion to calibrate the compass.');
            });
            
            // Toggle night mode
            nightModeBtn.addEventListener('click', () => {
                isNightMode = !isNightMode;
                document.body.style.background = isNightMode 
                    ? 'linear-gradient(135deg, #0a0a2a, #000000, #0a0a2a)' 
                    : 'linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d)';
                nightModeBtn.innerHTML = isNightMode 
                    ? '<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="white" d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-9 7.25c0-.55.45-1 1-1h4c.55 0 1 .45 1 1s-.45 1-1 1H4c-.55 0-1-.45-1-1z"/></svg>Day Mode'
                    : '<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="white" d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>Night Mode';
            });
            
            // Request necessary permissions
            function requestPermissions() {
                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by your browser');
                    return;
                }
                
                // Request location access
                navigator.geolocation.getCurrentPosition(
                    position => {
                        // Request device orientation access
                        if (typeof DeviceOrientationEvent !== 'undefined' && 
                            typeof DeviceOrientationEvent.requestPermission === 'function') {
                            DeviceOrientationEvent.requestPermission()
                                .then(permissionState => {
                                    if (permissionState === 'granted') {
                                        startApp(position);
                                    } else {
                                        alert('Device orientation permission is required for the compass to work.');
                                    }
                                })
                                .catch(console.error);
                        } else {
                            startApp(position);
                        }
                    },
                    error => {
                        alert('Unable to access your location. Please check your location settings.');
                        console.error('Geolocation error:', error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                );
            }
            
            // Start the application
            function startApp(position) {
                isActive = true;
                permissionRequest.style.display = 'none';
                
                // Initialize with current position
                updateLocation(position);
                
                // Watch for position changes
                navigator.geolocation.watchPosition(
                    updateLocation,
                    console.error,
                    { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
                );
                
                // Listen for device orientation changes
                if (typeof DeviceOrientationEvent !== 'undefined') {
                    window.addEventListener('deviceorientation', onHeadingChange);
                } else {
                    alert('Device orientation is not supported on your device.');
                }
            }
            
            // Handle device orientation changes
            function onHeadingChange(event) {
                if (!isActive) return;
                
                const heading = event.webkitCompassHeading || 
                               (360 - event.alpha); // Fallback for non-iOS devices
                
                if (typeof heading !== 'undefined' && heading !== null) {
                    currentHeading = heading;
                    positionHng.textContent = Math.round(360 - currentHeading) + '째';
                    
                    // Apply rotation to compass rose
                    rose.style.transform = `rotateZ(${currentHeading}deg)`;
                    
                    // Calculate difference between current heading and Qibla direction
                    const headingDifference = Math.abs(currentHeading - pointDegree);
                    const normalizedDifference = Math.min(headingDifference, 360 - headingDifference);
                    
                    // Update Qibla direction indicator
                    if (normalizedDifference < 5) {
                        qiblaDirection.innerHTML = '&#128331; You are facing Qibla &#128332;';
                        qiblaDirection.style.color = '#7befb2';
                    } else {
                        qiblaDirection.innerHTML = 'Point your device toward Qibla';
                        qiblaDirection.style.color = '#ffce54';
                    }
                }
            }
            
            // Update location and calculate Qibla direction
            function updateLocation(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                positionLat.textContent = lat.toFixed(6);
                positionLng.textContent = lng.toFixed(6);
                
                // Calculate Qibla direction
                pointDegree = calculateQiblaDirection(lat, lng);
                positionQib.textContent = Math.round(pointDegree) + '째';
                
                // Update Kabah position on compass
                updateKabahPosition(pointDegree);
            }
            
            // Calculate Qibla direction based on current location
            function calculateQiblaDirection(lat, lng) {
                const phiK = (kaabaCoords.lat * Math.PI) / 180.0;
                const lambdaK = (kaabaCoords.lng * Math.PI) / 180.0;
                const phi = (lat * Math.PI) / 180.0;
                const lambda = (lng * Math.PI) / 180.0;
                
                const psi = (180.0 / Math.PI) * Math.atan2(
                    Math.sin(lambdaK - lambda),
                    Math.cos(phi) * Math.tan(phiK) - 
                    Math.sin(phi) * Math.cos(lambdaK - lambda)
                );
                
                return (psi + 360) % 360; // Ensure positive value
            }
            
            // Update Kabah position on the compass
            function updateKabahPosition(degree) {
                const circle = document.querySelector('circle');
                const svgr = parseInt(circle.getAttribute('r'));
                const cx = parseInt(circle.getAttribute('cx'));
                const cy = parseInt(circle.getAttribute('cy'));
                const kw = parseInt(kabah.getAttribute('width'));
                const kh = parseInt(kabah.getAttribute('height'));
                
                const kx = Math.sin(degree * Math.PI / 180) * svgr + cx - (kw / 2);
                const ky = -Math.cos(degree * Math.PI / 180) * svgr + cy - (kh / 2);
                
                kabah.setAttribute('x', kx);
                kabah.setAttribute('y', ky);
                kabah.setAttribute('transform', `rotate(${degree}, ${kx + (kw/2)}, ${ky + (kh/2)})`);
            }
            
            // Initialize with a demo if permissions are not granted
            setTimeout(() => {
                if (!isActive) {
                    // Demo mode with sample data
                    positionLat.textContent = '21.422487';
                    positionLng.textContent = '39.826206';
                    positionQib.textContent = '0째';
                    positionHng.textContent = '0째';
                    updateKabahPosition(0);
                }
            }, 5000);
        });
    </script>
</body>
</html>
